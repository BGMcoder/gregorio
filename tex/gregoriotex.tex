%GregorioTeX file.
%Copyright (C) 2007-2013 Elie Roux <elie.roux@telecom-bretagne.eu>
%
%This program is free software: you can redistribute it and/or modify
%it under the terms of the GNU General Public License as published by
%the Free Software Foundation, either version 3 of the License, or
%(at your option) any later version.
%
%This program is distributed in the hope that it will be useful,
%but WITHOUT ANY WARRANTY; without even the implied warranty of
%MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%GNU General Public License for more details.
%
%You should have received a copy of the GNU General Public License
%along with this program.  If not, see <http://www.gnu.org/licenses/>.

% this file contains definitions for lines, initial, fonts, etc.

%%%%%%%%%%%%%%%%%%
%% engine checking
%%%%%%%%%%%%%%%%%%

\expandafter\ifx\csname RequirePackage\endcsname\relax
  \input ifluatex.sty
  \input luatexbase.sty
  \input luaotfload.sty
  \input graphicx.sty % for \resizebox
  \def\gre@error#1{\errmessage{GregorioTeX error: #1}}
  \def\gre@warning#1{\message{GregorioTeX warning: #1}}
\else
  \RequirePackage{ifluatex}
  \RequirePackage{graphicx}% for \resizebox
  \RequirePackage{luatexbase}
  \RequirePackage{luaotfload}
  \def\gre@error#1{\PackageError{GregorioTeX}{#1}{}}
  \def\gre@warning#1{\PackageWarning{GregorioTeX}{#1}}
\fi

\ifluatex\else
  \gre@error{Error: this document must be compiled with LuaTeX (lualatex)}
\fi

% Since TeXLive 2009, the extra primitives of LuaTeX have a luatex prefix, and are not
% available without prefix. We mostly rely on \directlua that is still available
% without prefix, but we also rely on the Omega primitives, that have a luatex 
% prefix in TeXLive 2009.

\let\gre@localleftbox\luatexlocalleftbox
\let\gre@localrightbox\luatexlocalrightbox
% an attribute we put on the text nodes.
% if it is 1, it means that there may be a dash here if this syllable is at the end of a line
% if it is 2, it means that it's never useful to typeset a dash
% if it is 0, it just means that we are in a score...
\newluatexattribute\gregorioattr
\def\gre@unsetattribute{\unsetluatexattribute{\gregorioattr}}

% an attribute used for translation centering
\newluatexattribute\gregoriocenterattr

\RequireLuaModule{gregoriotex}

% The general version of GregorioTeX (we mean by that the "API", the way
% Gregorio will write things)
\xdef\gregoriotexversion{20140516}

% the version of the internal files (all must have the same)
\xdef\gre@internalversion{20140516} % date format
\directlua{gregoriotex.check_version(\number\gre@internalversion)}

% first some macros to allow checks for version:
% #1 is the name of the file
% #2 is the version
\def\gre@declarefileversion#1#2{%
  \ifnum\number#2=\number\gre@internalversion\else %
    \gre@error{uncoherent file versions: gregoriotex.tex is in version \number\gre@internalversion \space\space while #1 is in version \number#2}
  \fi %
}

% macro called by scores
% #1 is the version of GregorioTeX the score is made for.
\def\gregoriotexapiversion#1{%
  \ifnum\number#1=\number\gregoriotexversion\else %
    \gre@error{GregorioTeX is in version \number\gregoriotexversion \space\space while a score you included requires version \number#1. Please recompile your scores}
  \fi %
}

%%%%%%%%%%%%%%%%%%%%%%%
%% aux file definitions
%%%%%%%%%%%%%%%%%%%%%%%

% for now, we only use an aux file with LuaTeX

\ifluatex
  \newwrite\Greaux
\fi

\def\grewriteaux#1{%
  \write\Greaux{#1}%
  \relax %
}

\def\opengreaux{%
  \openout\Greaux \jobname .gaux\relax%
}

\def\closegreaux{%
  \closeout\Greaux %
}


%%%%%%%%%%%%%%
%% basic start
%%%%%%%%%%%%%%

% factor is the factor with which you open you font (the number after the at). It will decide almost everything (spaces, etc.), so it is particularly important.
% at the beginning it is set to 0, but if it is still 0 when begingregorianscore is called, it is set to the default value : 17 (the value that makes it look like a standard graduale)
\newcount\gre@factor
\gre@factor=0
\ifdefined\setstaffsize%
	\gre@error{\protect\setstaffsize\space is already defined.  Check for package conflicts.}%
\else%
	\def\setstaffsize#1{%
		\gre@factor=#1%
	}%
\fi
\def\setgrefactor#1{%
	\gre@warning{\protect\setgrefactor\space is deprecated.\MessageBreak Use \protect\setstaffsize\space instead}
	\gre@factor=0
}

%%%%%%%%%%%%%%%%%%
%% vertical spaces
%%%%%%%%%%%%%%%%%%

\input gregoriotex-spaces.tex

% \gre@stafflinewidth is the width of a line of staff, this can vary, for example at the first line
\newdimen\gre@stafflinewidth

% \gre@linewidth is the width of a line of a score (including the initial)
\newdimen\gre@linewidth
\gre@linewidth=\hsize 
\gre@stafflinewidth=\gre@linewidth 

% to calculate that, we take the bottom of the third line : it is at 200 in the fonts, and it must be at gre@spacelinestext + gre@spacebeneathtext + 2*gre@interstafflinespace + 2*gre@stafflineheight + gre@translationheight
\def\gre@calculateconstantglyphraise{%
  \global\gre@constantglyphraise = -22000 sp%
  \global\multiply\gre@constantglyphraise by \the\gre@factor %
  \global\advance\gre@constantglyphraise by \gre@additionalbottomspace %
  \global\advance\gre@constantglyphraise by \gre@spacebeneathtext %
  \global\advance\gre@constantglyphraise by \gre@spacelinestext %
  \global\advance\gre@constantglyphraise by \gre@interstafflinespace %
  \global\advance\gre@constantglyphraise by \gre@interstafflinespace %
  \global\advance\gre@constantglyphraise by \gre@stafflineheight %
  \global\advance\gre@constantglyphraise by \gre@stafflineheight %
  \global\advance\gre@constantglyphraise by \gre@currenttranslationheight %
  % an adjustment in the case of big lines
  \global\advance\gre@constantglyphraise by \gre@stafflinediff %
  \relax %
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for additionnal vertical spaces
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% temporary value for space for the translation, beneath the text
\newdimen\gre@currenttranslationheight

% macro to tell gregorio to set space for the translation
\def\gre@addtranslationspace{%
  \global\gre@currenttranslationheight=\gre@translationheight %
  \global\gre@textlower=\gre@spacebeneathtext %
  \global\advance\gre@textlower by \gre@translationheight %
  \gre@generatelines %
  \gre@calculateconstantglyphraise %
  \relax %
}
\ifdefined\addtranslationspace%
	\gre@error{\addtranslationspace\space is already defined.  Check for package conflicts.}%
\else%
	\def\addtranslationspace{%
		\gre@addtranslationspace%
	}%
\fi

\def\gre@removetranslationspace{%
  \global\gre@currenttranslationheight=0 sp%
  \global\gre@textlower=\gre@spacebeneathtext %
  \gre@generatelines %
  \gre@calculateconstantglyphraise %
  \relax %
}
\ifdefined\removetranslationspace%
	\gre@error{\removetranslationspace\space is already defined.  Check for package conflicts.}%
\else%
	\def\removetranslationspace{%
		\gre@removetranslationspace%
	}%
\fi

%macro to call if you want to go to the next line simply
\def\grenewline{%
  \gre@newlinecommon{0}{0}{0}{0}{0}%
  \relax%
}

% macro called to go to the next line but when there are additional vertical spaces to add
%% 1: can be 0, 1 or 2 or 3. 1 is when there is a note above the 4th line, 2 when there is a note on the 5th line, and 3 when there is a note above the 5th line
%% 2: idem, but with the bottom line (-1th). It can be 4, in the case of a bottom note with a vertical episemus.
%% 3: 1 if there is a translation somewhere
% #4 is if 1 if we have space above the staff
\def\grenewlinewithspace#1#2#3#4{%
  \gre@newlinecommon{#1}{#2}{#3}{0}{#4}%
  \relax%
}


% basically same macros as above, but these one do a \hfill, the lines are not justified
%macro to call if you want to go to the next line simply
\def\grenewparline{%
  \gre@newlinecommon{0}{0}{0}{1}{0}%
  \relax%
}

\def\grenewparlinewithspace#1#2#3#4{%
  \gre@newlinecommon{#1}{#2}{#3}{1}{#4}%
}

% a macro describing a kern to make before ending the line, which we sometimes want (see \syllable)
\xdef\gre@kernbeforeeol{0pt\relax}

% the macro we call each time we force a changing of line, it automatically sets \greknownline, and adjusts left spaces
\def\gre@newlinecommon#1#2#3#4#5{%
  % sometimes we need to add a space before ending the line:
  \kern\gre@kernbeforeeol\relax %
  \ifnum\gre@boxing=0\relax %
    \ifnum\gre@biginitial=1\relax %
      \ifcase\gre@knownline %
      % 0: should not happend...
      \or % 1
        \greadjustsecondline %
      \or %2
        \greadjustthirdline %
      \fi %
    \fi %
    \global\advance\gre@knownline by 1\relax %
    \gre@updateadditionalspaces{#1}{#2}%
    \ifnum#3 = 1\relax %
      \gre@addtranslationspace %
    \else %
      \gre@removetranslationspace %
    \fi %
    \ifnum#5 = 1\relax %
      \gre@addspaceabove %
    \else %
      \gre@removespaceabove %
    \fi %
    \global\gre@lastoflinecount=2\relax %
    \ifnum\gre@insidediscretionary=0\relax %
      \gre@updateleftbox %
    \fi %
    \ifnum#4=1\relax %
      \hfill %
    \fi %
    \gre@penalty{-10001}%
  \fi %
  \relax %
}

% two dimensions for the additionalspaces
\newdimen\gre@additionalbottomspace
\newdimen\gre@additionaltopspace

% same arguments as \gre@newlinewithspace
\def\gre@updateadditionalspaces#1#2{%
  \ifcase#1\relax %
    \global\gre@additionalbottomspace=0 sp%
  \or % case 1
    \global\gre@additionalbottomspace=0 sp%
    % here we don't add any space... it's just in case...
  \or % case 2
    \global\gre@additionaltopspace=15000 sp%
    \global\multiply\grea@dditionaltopspace by \the\gre@factor %
  \or % case 3
    \global\gre@additionaltopspace=30000 sp%
    \global\multiply\gre@additionaltopspace by \the\gre@factor %
  \fi %
  \ifcase#2\relax %
    % case 0
    \global\gre@additionalbottomspace=0 sp%
  \or % case 1
    \global\gre@additionalbottomspace=0 sp%
  \or % case 2
    \global\gre@additionalbottomspace=15000 sp%
    \global\multiply\gre@additionalbottomspace by \the\gre@factor %
  \or % case 3
    \global\gre@additionalbottomspace=30000 sp%
    \global\multiply\gre@additionalbottomspace by \the\gre@factor %
  \or % case 4
    \global\gre@additionalbottomspace=45000 sp%
    \global\multiply\gre@additionalbottomspace by \the\gre@factor %
  \fi %
  \gre@generatelines %
  \gre@calculateconstantglyphraise %
  \relax %
}

%% macros for additional bottom space for the first line

% #1 is 1, 2 or 3, with the same signification as in grenewlinewithspace
\def\grefirstlinebottomspace#1#2{%
  \ifcase#1\relax %
    % case 0
    \global\gre@additionalbottomspace=0 sp%
  \or % case 1
    \global\gre@additionalbottomspace=0 sp%
  \or % case 2
    \global\gre@additionalbottomspace=15000 sp%
    \global\multiply\gre@additionalbottomspace by \the\gre@factor %
  \or % case 3
    \global\gre@additionalbottomspace=30000 sp%
    \global\multiply\gre@additionalbottomspace by \the\gre@factor %
  \fi %
  \ifnum#2=1\relax %
    \gre@addtranslationspace %
  \else %
    \gre@removetranslationspace %
  \fi %
  \gre@generatelines %
  \gre@calculateconstantglyphraise %
  \relax %
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of text
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% \gre@textlower is the height of the separation between the bottom line (which is invisible : for the notes which are very low) and the bottom of the text
\newdimen\gre@textlower
\gretextlower=\gre@spacebeneathtext
%\advance\gretextlower by \translationheight

%% macro that sets \gre@tempwidth to the width of its argument

\newbox\Gre@Tempwidth
\newdimen\gre@tempwidth

\def\gre@widthof#1{%
  \setbox\Gre@Tempwidth=\hbox{#1}%
  \global\gre@tempwidth=\wd\Gre@Tempwidth%
  \relax%
}

%% macro that typesets the text of the syllable, and sets \gre@textaligncenter to the middle of the middle letters, it is needed because we align the note (often the middle of the note) with the middle of the middle letters
%% third argument is 0 if it's the current syllable, 1 if it's the alignment of the following one
%% warning: \gre@textaligncenter is the width from the beginning of the letters to the middle of the middle letters
%% warning: value is approximative when a ligature appears

\newdimen\gre@textaligncenter

\def\gre@findtextaligncenter#1#2#3{%
  \ifnum#3=0\relax%
    \gre@widthof{\gre@fixedtextformat{#1#2}}%
  \else %
    \gre@widthof{\gre@fixednexttextformat{#1#2}}%
  \fi %
  \global\gre@textaligncenter=\the\gre@tempwidth %
  \ifnum#3=0\relax%
    \gre@widthof{\gre@fixedtextformat{#2}}%
  \else %
    \gre@widthof{\gre@fixednexttextformat{#2}}%
  \fi %
  \divide\gre@tempwidth by 2 %
  \global\advance\gre@textaligncenter by -\the\gre@tempwidth%
  \relax%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of the initial
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%this dimention is the additional space that we have to add to the localleftbox sometimes. For now it is used only for the initials on two lines
\newdimen\gre@additionalleftspace

%% box containing the initial, and dimen containing its width (and the width of the space after)
\newbox\Gre@Initial
\newdimen\gre@initialwidth
\gre@initialwidth= 0 pt


% grebiginitial means that the inital takes two lines
\newcount\gre@biginitial

% greknownline is the line we think we are in
\newcount\gre@knownline

% macro to call before the call of \initial
\def\gresetbiginitial{%
  \global\gre@biginitial=1\relax %
  \relax %
}

% macro to cancel before the call of \initial
\def\grenormalinitial{%
  \global\gre@biginitial=0\relax %
  \relax %
}

% macro to call before the first syllable, but after \gresetinitialclef
\def\greadjustsecondline{%
  \gre@additionalleftspace=\gre@initialwidth %
  \gre@updateleftbox %
  \relax %
}

% macro to call during the second line
\def\greadjustthirdline{%
  \gre@additionalleftspace= 0 pt%
  \gre@updateleftbox %
  \relax %
}

\def\gre@updateleftbox{%
  \gre@updatelinewidth %
  \gre@updatelinesclef %
}

\def\gre@updatelinewidth{%
  \ifdim\gre@additionalleftspace=0pt%
  \else %
    \gre@tempdim=\gre@stafflinewidth %
    \global\advance\gre@stafflinewidth by -\gre@additionalleftspace %
    \gre@generatelines %
    \global\gre@stafflinewidth=\gre@tempdim %
  \fi %
}

\def\greinitial#1{%
  % see comments on this function to see what it does
  \gre@setaboveinitialraise %
  % we print the initial always at the same place, and the we print the GreAboveinitialfirstbox  centered
  % first we print the initial
  \gre@tempdim=-\gre@textlower %
  % if it is a big initial we print it on the second line 
  \ifnum\gre@biginitial=0\relax %
    \setbox\Gre@Initial=\hbox{\gre@initialformat{#1}}%
    \global\gre@initialwidth=\the\wd\Gre@Initial %
    \setbox\Gre@Initial=\hbox{\raise -\gre@tempdim\hbox{\gre@initialformat{#1}}}%
  \else %
    \advance\gre@tempdim by \gre@additionalbottomspace %
    \advance\gre@tempdim by \gre@spacebeneathtext %
    \advance\gre@tempdim by \gres@pacelinestext %
    \advance\gre@tempdim by 4\gre@interstafflinespace %
    \advance\gre@tempdim by 4\gre@stafflineheight %
    \advance\gre@tempdim by \gre@currenttranslationheight %
    \setbox\Gre@Initial=\hbox{\gre@biginitialformat{#1}}%
    \global\gre@initialwidth=\the\wd\Gre@Initial %
    \setbox\Gre@Initial=\hbox{\vbox to 0pt{\hbox{\raise -\gre@tempdim\hbox{\gre@biginitialformat{#1}}}\vss}}%
  \fi %
  \hskip\gre@beforeinitialshift %
  \copy\Gre@Initial%
  \hskip\gre@afterinitialshift %
  \global\advance\gre@initialwidth by \gre@afterinitialshift%
  \global\advance\gre@initialwidth by \gre@beforeinitialshift %
  % then we center the first box above the initial, if there is one
  \ifdim\wd\Gre@Aboveinitialfirstbox=0 pt\relax %
  \else %
    \gre@tempdim=\gre@initialwidth %
    \advance\gre@tempdim by -\wd\Gre@Aboveinitialfirstbox  %
    \divide\gre@tempdim by 2 %
    \hskip -\gre@initialwidth %
    \kern\gre@tempdim %
    \raise\gre@aboveinitialfirstraise\copy\Gre@Aboveinitialfirstbox  %
    \kern\gre@tempdim %
    \setbox\Gre@Aboveinitialfirstbox=\hbox{}%
  \fi %
  % then we center the second box above the initial, if there is one
  \ifdim\wd\Gre@Aboveinitialsecondbox=0 pt\relax %
  \else %
    \gre@tempdim=\gre@initialwidth %
    \advance\gre@tempdim by -\wd\Gre@Aboveinitialsecondbox %
    \divide\gre@tempdim by 2 %
    \hskip -\gre@initialwidth %
    \kern\gre@tempdim %
    \raise\gre@aboveinitialsecondraise\copy\Gre@Aboveinitialsecondbox %
    \kern\gre@tempdim %
    \setbox\Gre@Aboveinitialsecondbox=\hbox{}%
  \fi %
  \relax %
}

\def\grenoinitial{%
  \setbox\Gre@Initial=\hbox{}%
  \global\gre@initialwidth=0pt %
  \global\gre@lastoflinecount=2\relax %
  \relax %
}

%Ideas to simplify the setting of annotations:
%1) Have one box which contains the annotations.  Box is empty at start.
%2) Have one function which adds a line to annotation.  Function has one required argument (the annotation to be added) and two optional arguments (horizontal alignment with current box contents and additional space between elements)


% We set two boxes for the two lines above the initial

\newbox\Gre@Aboveinitialfirstbox
\newdimen\gre@aboveinitialfirstraise
\newbox\Gre@Aboveinitialsecondbox
\newdimen\gre@aboveinitialsecondraise
% the height difference between the bottom of the first annotation line and the top of the second annotation line (above the initial) is controlled by the \gre@aboveinitialseparation space, in gregoriotex-spaces.tex

\ifdefined\setfirstlineaboveinitial%
	\gre@error{\protect\setfirstlineaboveinitial\space is already defined.  Check for package conflicts.}%
\else%
	\def\setfirstlineaboveinitial#1#2{%
	  \ifnum\gre@factor=0\relax %
	    \setstaffsize{17}%
	  \fi %
	  % we align the baseline of the box with the top of the line
	  % here the variables are a bit strange... we can calculate the final value of \gre@aboveinitialfirstraise only after the beginning of the score, after the call to this macro. So we just set \gre@aboveinitialfirstraise to the negative value the #2 will add, and then, after the beginning of the score, we'll add \gre@setaboveinitialraise that will... set \gre@aboveinitialfirstraise.
	  \setbox\Gre@Aboveinitialfirstbox=\hbox{#2}%
	  \global\gre@aboveinitialfirstraise=-\ht\Gre@Aboveinitialfirstbox %
	  \global\setbox\Gre@Aboveinitialfirstbox=\hbox{#1}%
	  \relax %
	}
\fi

\def\gresetfirstlineaboveinitial#1#2{%
	\gre@warning{\protect\gresetfirstlineaboveinitial\space is deprecated.\MessageBreak Use \protect\setfirstlineaboveinitial\space instead}%
	\gre@setfirstlineaboveinitial#1#2%
	\relax%
}

\def\gresetfirstannotation#1{%
	\gre@warning{\protect\gresetfirstannotaion\space is deprecated.\MessageBreak Use \protect\setfirstannoation\space instead}
	\setfirstlineaboveinitial{#1}{#1}%
	\relax %
}
\ifdefined\setfirstannotation%
	\gre@error{\protect\setfirstannoation\space is already defined.  Check for package conflicts.}%
\else%
	\def\setfirstannotation{%
		\setfirstlineaboveinitial{#1}{#1}%
		\relax %
	}
\fi

\ifdefined\setsecondannotation%
	\gre@error{\protect\setsecondannoations\space is already defined.  Check for package conflicts.}%
\else%
	\def\setsecondannotation#1{%
	  \ifnum\grefactor=0\relax %
	    \setgrefactor{17}%
	  \fi %
	  \setbox\Gre@Aboveinitialsecondbox=\hbox{#1}%
	  \global\gre@aboveinitialsecondraise=-\ht\Gre@Aboveinitialsecondbox %
	  \global\advance\gre@aboveinitialsecondraise by -\gre@aboveinitialseparation %
	  \relax %
	}
\fi

\def\gresetsecondannotation#1{%
	\gre@warning{\protect\gresetsecondannotation\space is already deprecated.\MessageBreak Use \protect\setsecondannotation\space instead}%
	\setsecondannotation#1%
}

%here we set the true raises of the two lines above the inital
\def\gresetaboveinitialraise{%
  \global\advance\gre@aboveinitialfirstraise by \gre@staffheight %
  \global\advance\gre@aboveinitialfirstraise by \gre@spacebeneathtext %
  \global\advance\gre@aboveinitialfirstraise by \gre@currenttranslationheight %
  \global\advance\gre@aboveinitialfirstraise by \gre@spacelinestext %
  \global\advance\gre@aboveinitialfirstraise by \gre@additionalbottomspace %
  \global\advance\gre@aboveinitialsecondraise by \gre@aboveinitialfirstraise %
  \relax %
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the score reference (unused)
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\grescorereference#1{}
\def\scorereference#1{%
  \relax%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting the things above the initial
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\writemode#1{%
  \gresetfirstlineaboveinitial{\sc{\bf{#1}}}{\sc{\bf{#1}}}%
  \relax %
}

\def\gregorianmode#1{%
  \ifcase#1%
  \or%
    \writemode{I}%
  \or%
    \writemode{II}%
  \or%
    \writemode{III}%
  \or%
    \writemode{IV}%
  \or%
    \writemode{V}%
  \or%
    \writemode{VI}%
  \or%
    \writemode{VII}%
  \or%
    \writemode{VIII}%
  \fi%
  \relax%
}

%% macro that draws the lines : starts by the first and then draws the lines of every line.
%% has to be called before drawing the key, after drawing the initial
\def\grebeginnotes{%
  \gre@drawfirstlines %
  %%localeleftbox is a primitive of Omega, it draws the same box at the beginning of new lines (here after the first)
  \gre@localleftbox{%
    \copy\Gre@Lines %
  }%
  \relax %
}

\def\commentary#1{%
  \vbox{\hfill\hbox{#1}}%
  \relax %
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macro for putting text above lines for annotations and the like
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% additional space for the text above lines
\newdimen\gre@currentabovelinestextheight
\gre@currentabovelinestextheight = 0pt

% A pseudo-environment for styling the text above the lines.  gregoriotex.sty redefines this to a real LaTeX environment for LaTeX users.
\def\gre@abovelinestextstyle#1{%
\startabovelinetextstyle#1\stopabovelinetextstyle\relax %
}
\def\startabovelinetextstyle{%
	\begingroup
	\it
}
\def\stopabovelinetextstyle{%
	\endgroup
}

% set space above the text lines - almost the same as for the translation
\def\gre@addspaceabove{%
  \global\gre@currentabovelinestextheight=\gre@abovelinestextheight %
  \gre@generatelines %
  \relax %
}

% we don't need space above any more
\def\gre@removespaceabove{%
  \global\gre@currentabovelinestextheight=0 sp%
  \gre@generatelines %
  \relax %
}

% the code is a bit strange here: we always execute \gre@spaceabovelines at the beginning of a glyph. This will:
%  - typeset the text above the lines if relevant, and making sure we execute it only once
%  - not do anything else

\xdef\gre@currenttextabovelines{}

\def\gresettextabovelines#1{%
  \gdef\gre@currenttextabovelines{%
    \gre@typesettextabovelines{#1}%
    \gdef\gre@currenttextabovelines{}%
    \relax %
  }%
}

% typesets the text above the line
\def\gre@typesettextabovelines#1{%
  \global\gre@tempdim=\gre@abovelinestextraise %
  \global\advance\gre@tempdim by 4\gre@stafflineheight %
  \global\advance\gre@tempdim by 4\gre@interstafflinespace %
  \global\advance\gre@tempdim by \gre@spacebeneathtext %
  \global\advance\gre@tempdim by \gre@currenttranslationheight %
  \global\advance\gre@tempdim by \gre@spacelinestext %
  \global\advance\gre@tempdim by \gre@additionalbottomspace %
  \leavevmode\raise\gre@tempdim\hbox to 0pt{\gre@abovelinestextstyle{#1}\hss}%
  \relax %
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of the lines
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% first a macro to prevent the typesetting of the lines (useful for some people)
\xdef\gre@removelinescount{0}

\ifdefined\removelines%
	\gre@error{\protect\removelines\space is already defined.  Check for package conflicts.}%
\else%
	\def\removelines{%
		\xdef\gre@removelinescount{1}%
		\relax %
	}
\fi
\def\greremovelines{%
	\gre@warning{\protect\greremovelines\space is deprecated.\MessageBreak Use \protect\removelines\space instead.}%
	\removelines%
}

\ifdefined\donotremovelines%
	\gre@error{\protect\donotremovelines\space is already defined.  Check for package conflicts.}%
\else%
	\def\donotremovelines{%
		\xdef\gre@removelinescount{0}%
		\relax %
	}
\fi
\def\gredonotremovelines%
	\gre@warning{\protect\gredonotremovelines\space is deprecated.\MessageBreak use \protect\donotremovelines\space instead.}%
	\donotremovelines%
}

%% macro that draws the stafflines on the first line, it is different from others due to the initial that can take some place, without lines
\def\gre@drawfirstlines{%
  \advance\gre@stafflinewidth by -\gre@initialwidth%
  %\greinitialwidth=0pt%
  \hbox to 0pt{%
    \vbox{%
      \gre@normalstafflinesformat %
      \vskip\gre@currentabovelinestextheight %
      \vskip\gre@additionaltopspace %
      \ifnum\gre@removelinescount=0\relax %
        \hrule height \gre@stafflineheight width \gre@stafflinewidth %
      \else %
        \vskip\gre@stafflineheight %
      \fi %
      \kern\the\gre@interstafflinespace %
      \ifnum\gre@removelinescount=0\relax %
        \hrule height \gre@stafflineheight width \gre@stafflinewidth %
      \else %
        \vskip\gre@stafflineheight %
      \fi %
      \kern\the\gre@interstafflinespace %
      \ifnum\gre@removelinescount=0\relax %
        \hrule height \gre@stafflineheight width \gre@stafflinewidth %
      \else %
        \vskip\gre@stafflineheight %
      \fi %
      \kern\the\gre@interstafflinespace %
      \ifnum\gre@removelinescount=0\relax %
        \hrule height \gre@stafflineheight width \gre@stafflinewidth %
      \else %
        \vskip\gre@stafflineheight %
      \fi %
      \vskip\gre@spacelinestext %
      \vskip\gre@spacebeneathtext %
      \vskip\gre@currenttranslationheight %
      \vskip\gre@additionalbottomspace %
    }%
    \hss%
  }%
  \gre@stafflinewidth=\gre@linewidth%
  \relax%
}

%% box containing the stafflines for other lines than the first
\newbox\Gre@Lines

% macro that must be called at each change of linewidth and grefactor
\def\gre@generatelines{%
  \setbox\Gre@Lines=\hbox to 0pt{%
    \vbox{%
      \gre@normalstafflinesformat %
      \vskip\gre@spaceabovelines %
      \vskip\gre@currentabovelinestextheight %
      \ifnum\gre@removelinescount=0\relax %
        \hrule height \gre@stafflineheight width \gre@stafflinewidth %
      \else %
        \vskip\gre@stafflineheight %
      \fi %
      \kern\the\gre@interstafflinespace %
      \ifnum\gre@removelinescount=0\relax %
        \hrule height \gre@stafflineheight width \gre@stafflinewidth %
      \else %
        \vskip\gre@stafflineheight %
      \fi %
      \kern\the\gre@interstafflinespace %
      \ifnum\gre@removelinescount=0\relax %
        \hrule height \gre@stafflineheight width \gre@stafflinewidth %
      \else %
        \vskip\gre@stafflineheight %
      \fi %
      \kern\the\gre@interstafflinespace %
      \ifnum\gre@removelinescount=0\relax %
        \hrule height \gre@stafflineheight width \gre@stafflinewidth %
      \else %
        \vskip\gre@stafflineheight %
      \fi %
      \vskip\gre@spacelinestext %
      \vskip\gre@additionalbottomspace %
      \vskip\gre@spacebeneathtext %
      \vskip\gre@currenttranslationheight %
    }%
    \hss%
  }%
  \relax %
}

% macro called when the initial is big, and so when the second line is at the same level as the first
\def\gre@smallsecondline{%
  \gre@tempdim=\gre@stafflinewidth %
  \global\advance\gre@stafflinewidth by -\gre@initialwidth %
  \gre@generatelines %
  \global\gre@stafflinewidth=\gre@tempdim %
  \relax %
}

% macro called when we are after the second line of a big initial, to have normal lines back
\def\gre@normallines{%
  \global\gre@stafflinewidth=\gre@linewidth %
  \gre@generatelines %
  \relax %
}

\input gregoriotex-signs.tex

\input gregoriotex-syllable.tex

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the translations
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\xdef\gre@translationcenteringscheme{0}

\ifdefined\settranslationcenteringscheme%
	\gre@error{\protect\settranslationcenteringscheme\space is already defined.  Check for package conflicts.}%
\else%
	\def\settranslationcenteringscheme#1{%
		\xdef\gre@translationcenteringscheme{\number #1}%
	}%
\fi
\def\setgretranslationcenteringscheme#1{%
	\gre@warning{\protect\setgretranslationcenteringscheme\space is deprecated.\MessageBreak Use \protect\settranslationcenteringscheme\space instead}%
	\settranslationcenteringscheme{#1}%
}

\xdef\gre@nlbintranslation{0}

\def\setnlbintranslation#1{%
  \xdef\gre@nlbintranslation{\number #1}%
}

\def\grewritetranslation#1{%
  \ifnum\gre@translationcenteringscheme=0\relax %
    \raise\gre@spacebeneathtext\hbox to 0pt{\vbox to 0pt{\vss\hbox to 0pt{\gre@translationformat{#1}\hss}}}%
  \else %
    \gre@tempdim=\wd\Gre@Syllabletext %
    \setbox\Gre@Tempwidth=\hbox{#1}%
    \advance\gre@tempdim by -\wd\Gre@Tempwidth %
    \divide\gre@tempdim by 2\relax %
    \kern \gre@tempdim %
    \raise\gre@spacebeneathtext\hbox to 0pt{\vbox to 0pt{\vss\hbox to 0pt{\gre@translationformat{#1}\hss}}}%
    \kern -\gre@tempdim %
  \fi %
}

\def\gre@translationformat#1{%
	\starttranslationformat#1\stoptranslationformat%
	\relax%
}
\def\starttranslationformat{%
	\begingroup%
	\it%
}
\def\stoptranslationformat{%
	\endgroup%
}


\def\grewritetranslationwithcenterbeginning#1{%
  \ifnum\gre@nlbintranslation=1\relax %
    \grebeginnlbarea{0}{1}%
  \fi %
  \gregoriocenterattr=1\relax %
  \raise\gre@spacebeneathtext\hbox to 0pt{\kern 0pt\vbox to 0pt{\vss\hbox to 0pt{\gre@translationformat{#1}\hss}}\kern 0pt}%
  \unsetluatexattribute{\gregoriocenterattr}%
  \relax %
}

\xdef\gre@mustdotranslationcenterend{0}

\def\gretranslationcenterend{%
  \xdef\gre@mustdotranslationcenterend{1}%
  \relax %
}

\def\gre@dotranslationcenterend{%
  \ifnum\gre@nlbintranslation=1\relax %
    \greendnlbarea{0}{1}%
  \fi %
  \gregoriocenterattr=2\relax %
  \raise\gre@spacebeneathtext\hbox to 0pt{}%
  \unsetluatexattribute{\gregoriocenterattr}%
  \relax %
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the chironomic signs lines
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% here is a quite special macro called at beggining of lines, that inserts a line of chironomic signs
\def\greinsertchiroline{%
  % the first line is a special case
  \ifnum\gre@knownline=1\relax %
    % some bugs appear if we don't box it
    \hbox{\directlua{grechiro.printLine()}}%
    \par %
    % TODO: this line bugs with my version of LuaTeX
    %\grenobreak %
    \kern\gre@belowsignsspace %
    %\grenobreak %
    \noindent %
  \else %
    % not very beaufiful, I don't like to make a new par inside a score, but....
    \gre@localleftbox{}%
    \gre@localrightbox{}%
    \par %
    \kern\gre@abovesignsspace %
    \noindent\hbox{\directlua{grechiro.printLine()}}%
    \gre@updateleftbox %
    \par %
    \gre@nobreak%
    \kern\gre@belowsignsspace %
    \gre@nobreak %
    \noindent %
  \fi %
  \relax %
}

%macro to call just after begingregorioscore, if there are some chironomic signs
\def\greactivatechironomy{%
  % we print the absolute position of the beginning of the score, and the width of a line, to get the absolute positions of the begginning and end of lines
  \pdfsavepos %
  \grewriteaux{begin:\number\pdflastxpos}%
  \grewriteaux{width:\number\grestafflinewidth}%
  \RequireLuaModule{gregoriotex-ictus}%
  \directlua{grechiro.atBeginScore()}%
\fi %
}

% count that is 1 or 0 if we need to print the small vertical bars in the chironomic line
\newcount\gre@printchirovbars
\gre@printchirovbars=1


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% other macros
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% gregorioattr (see its definition in gregorio-syllable) is 0 when we are in a score, and unset when we are not

%macro called at the beginning of a score
\def\begingregorioscore{%
  % not sure it's perfect to put that here, but it's the only way I found to make it work....
  \gre@cancelpenalties %
  \gre@dofinetuning %
  \global\gre@linewidth=\hsize %
  \gregorioattr=0\relax %
  \xdef\gre@exhyphencharsave{\the\exhyphenchar}%
  \exhyphenchar=-1\relax %
  \global\gre@stafflinewidth=\gre@linewidth %
  \gre@generatelines %
  \ifnum\gre@factor=0\relax %
    \setstaffsize{17}%
    \gre@setverticalspaces %
  \fi %
  \noindent%
  \directlua{gregoriotex.atScoreBeggining()}%
  %TODO do something like LaTeX's AtBeginDocument
  \ifdefined\optgabcAtScoreBeginning %
    \optgabcAtScoreBeginning %
  \fi %
  \global\gre@knownline=1\relax %
  \relax%
}

%macro called at the end of a score
\def\endgregorioscore{%
  \global\gre@lastoflinecount=0\relax %
  \global\gre@blockcusto=0\relax %
  \ifnum\gre@nlbstate=0\else %
    \greendnlbarea{2}%
  \fi %
  \gre@localleftbox{}%
  \ifnum\keeprightbox=0\relax %
    \gre@localrightbox{}%
  \fi %
  \hfil %
  \par %
  \ifnum\keeprightbox=1\relax %
    \global\keeprightbox=0\relax %
  \fi%
  \gre@unsetattribute %
  % with some versions of LuaTeX, the \localrightbox and \localleftbox must be set empty in an environment with the good attributes set
  \gre@localleftbox{}%
  \gre@localrightbox{}%
  \setbox\Gre@Aboveinitialfirstbox=\hbox{}%
  \gre@updateadditionalspaces{0}{0}%
  \global\gre@currentabovelinestextheight=0 sp%
  \gre@removetranslationspace %
  \grenormalinitial %
  \gre@restorepenalties %
  \gre@endfinetuning %
  \exhyphenchar=\gre@exhyphencharsave %
  \directlua{gregoriotex.atScoreEnd()}%
  \relax%
}

% macro to call when there is just a little thing that will go to the last line,
% when it is not necessary
% It doesn't seem to be used, so it's a good candidate for deprecation!
\def\gre@nolastline{%
  \ifdim\gre@enddifference > 0 pt %
    \ifdim\gre@nextbegindifference > 0 pt %
      \hskip\gre@interwordspacenotes %
    \else % (next begin difference >0pt)
      \hskip\gre@interwordspacenotestext %
    \fi %
  \else%(enddifference < Opt)
    \ifdim\gre@nextbegindifference < 0 pt %
      \hskip\gre@interwordspacetext %
    \else %(next begin difference < 0 pt)
      \hskip\gre@interwordspacetextnotes %
    \fi %
  \fi %
  \global\gre@endofscore=1 %
  \gre@localrightbox{}%
  \gre@localleftbox{}%
  \penalty{\gre@nolastlinepenalty }%
  \relax%
}

% macro called at each end of word
\def\gre@endofword#1{%
  \gre@penalty{\gre@endofwordpenalty }%
  \ifnum#1=1\relax %
    \ifdim\gre@enddifference > 0 pt %
      \ifdim\gre@nextbegindifference > 0 pt %
        \gre@hskip\gre@interwordspacenotes %
      \else % (next begin difference >0pt)
        \gre@hskip\gre@interwordspacenotestext %
      \fi %
    \else %(enddifference < Opt)
      \ifdim\gre@nextbegindifference < 0 pt %
        \gre@hskip\gre@interwordspacetext %
      \else %(next begin difference < 0 pt)
        \gre@hskip\gre@interwordspacetextnotes %
      \fi %
    \fi %
  \fi %
  %\global\greenddifference=0pt %
  \relax%
}

% macro called at the end of a word or syllable when the next thing is a bar
\def\gre@endbeforebar#1{%
  \gre@nobreak %
  \ifnum#1=1\relax %
    \ifdim\gre@enddifference > 0 pt %
      \ifdim\gre@nextbegindifference > 0 pt %
        \gre@hskip\gre@notebarspace %
      \else % (next begin difference >0pt)
        \grehskip\gre@textbartextspace %
      \fi %
    \else%(enddifference < Opt)
      \ifdim\gre@nextbegindifference < 0 pt %
        \gre@hskip\gre@textbartextspace %
      \else %(next begin difference < 0 pt)
        \gre@hskip\gre@interwordspacetextnotes %
      \fi %
    \fi %
  \fi %
  \gre@nobreak %
  %\global\greenddifference=0pt %
  \relax %
}

% macro called at the end of a bar. Almost the same, but not for the penalties
\def\gre@endafterbar#1{%
  \gre@penalty{\gre@endafterbarpenalty }\relax %
  \ifnum#1=1\relax %
    \ifdim\gre@enddifference > 0 pt %
      \ifdim\gre@nextbegindifference > 0 pt %
        \gre@hskip\gre@notebarspace %
      \else % (next begin difference >0pt)
        \gre@hskip\gre@textbartextspace %
      \fi %
    \else%(enddifference < Opt)
      \ifdim\gre@nextbegindifference < 0 pt %
        \gre@hskip\gre@textbartextspace %
      \else %(next begin difference < 0 pt)
        \gre@hskip\gre@interwordspacetextnotes %
      \fi %
    \fi %
  \fi %
  %\grepenalty{\greendafterbarpenalty }\relax %
  %\global\greenddifference=0pt %
  \relax %
}

\newcount\gre@lastoflinecount

% TODO: case where we're at the beginning *and* end of a line... quite rare case though...
% macro to tell gregorioTeX no to put a space after the current syllable (otherwise it may cause annoying black boxes in the pdf if written in plainTeX)
% 0 if nothing
% 1 if the syllable is the last of the line
% 2 after it has finished the syllable, so when it is two it means that the syllable is the first of a line
\def\grelastofline{%
  \global\gre@lastoflinecount=1\relax%
  \relax%
}

% same as above, but for the score. For now it is the same behaviour.
\def\grelastofscore{%
%  \grelocalleftbox{}% For an unknown reason, if I uncomment this line, the
%  blank line removing algorithm (in lua) will let some blank space after the
%  last line... (see bug #20953)
  \gre@blockcustos %
  \global\gre@lastoflinecount=1\relax%
  \relax%
}

% a macro to disable (or reenable) the left shift for first syllables of scores
\edef\gre@disableeolshifts{0}

\def\Gre@DisableEOLShifts{%
  \xdef\gre@disableeolshifts{1}%
}

\def\Gre@EnableEOLShifts{%
  \xdef\gre@disableeolshifts{0}%
}

% a count that is 1 if we block the custo, and 0 if we don't. We just block custos at the end of a score, to prevent a bug.
\newcount\gre@blockcusto

% macro to suppress the custos
\ifdefined\blockcustos%
	\gre@error{\protect\blockcustos\space is already defined.  Check for package conflicts.}%
\else%
	\def\blockcustos{%
		\global\gre@blockcusto=1\relax %
		\gre@localrightbox{}%
		\relax %
	}%
\fi
\def\greblockcustos{%
	\gre@warning{\protect\greblockcustos\space is deprecated.\MessageBreak Use \protect\blockcustos\space instead}%
	\blockcustos%
}

% macro called at each end of syllable which is not an end of word
\def\gre@endofsyllable{%
  \gre@penalty{\gre@endofsyllablepenalty }%
  \relax%
}

% macro to end elements, #1 is the type of space, it can be : 
%% 0: default space 
%% 1: larger space
%% 2: glyph space
%% 3: zero-width space
% #2 is if the space is unbreakable (1) or not (0)

\def\greendofelement#1#2{%
  \ifnum #2=0\relax %
    \gre@penalty{\gre@endofelementpenalty}%
  \else %
    \gre@nobreak %
  \fi %
  \ifcase#1%
    \gre@hskip\gre@interelementspace %
  \or% case 1
    \gre@hskip\gre@largerspace %
  \or% case 2
    \gre@hskip\gre@glyphspace %
  \fi%
  \ifnum #2=1\relax %
    \gre@nobreak %
  \fi %
\relax%
}

% macro to end a glyph without ending the element, argument is the type of space, it can be : 
%% 0: default space 
%% 1: zero width space
%% 2: space between flat or natural and a note
%% 3: space between two puncta inclinata
%% 4: space between bivirga or trivirga
%% 5: space between bistropha or tristropha
%% 6: space after a punctum mora XXX: not used yet, not so sure it is a good idea...
%% 7: space between a punctum inclinatum and a punctum inclinatum debilis
%% 8: space between two puncta inclinata debilis
%% 9: space before a punctum (or something else) and a punctum inclinatum
%% 10: space between puncta inclinata (also debilis for now), larger ambitus (range=3rd).
%% 11: space between puncta inclinata (also debilis for now), larger ambitus (range=4th or more)
\def\greendofglyph#1{%
  \gre@nobreak %
  \ifcase#1%
    \gre@hskip\gre@interglyphspace %
  \or% case 1
    \gre@hskip\gre@zerowidthspace %
  \or% case 2
    \gre@hskip\gre@alterationspace %
  \or% case 3
    \gre@hskip\gre@punctuminclinatumshift %
  \or% case 4
    \gre@hskip\gre@bitrivirspace %
  \or% case 5
    \gre@hskip\gre@bitristrospace %
  \or% case 6
    \gre@hskip\gre@spaceaftersigns %
  \or% case 7
    \gre@hskip\gre@punctuminclinatumanddebilisshift %
  \or% case 8
    \gre@hskip\gre@punctuminclinatumdebilisshift %
  \or% case 9
    \gre@hskip\gre@beforepunctainclinatashift %
  \or% case 10
    \gre@hskip\gre@punctuminclinatumbigshift %
  \or% case 11
    \gre@hskip\gre@punctuminclinatummaxshift %
  \fi%
  \gre@nobreak %
  \relax%
}

% The different states of line break areas:
% 0: not currently in a no line break area
% 1: no line break area due to translation centering
% 2: no line break area due to <nlba> tag
\xdef\gre@nlbstate{0}

% first argument is if the nlba is starting in neumes or not
% second argument is if it is called from translation centering or not
\def\grebeginnlbarea#1#2{%
  \xdef\gre@nlbinitialstate{\gre@nlbstate}%
  \ifnum#2=0\relax %
    \xdef\gre@nlbstate{2}%
  \else %
      \ifcase\gre@nlbstate %
        \xdef\gre@nlbstate{1}%
      \or %
        \xdef\gre@nlbstate{1}%
      \or %
        \xdef\gre@nlbstate{2}%
      \fi %
  \fi %
  \ifnum\gre@nlbinitialstate=0\relax %
      \xdef\gre@nobreakpenaltysave{\gre@nobreakpenalty }%
      \xdef\gre@nobreakpenalty{10001}%
      \xdef\gre@nolastlinepenaltysave{\gre@nolastlinepenalty }%
      \xdef\gre@nolastlinepenalty{10001}%
      \xdef\gre@endofwordpenaltysave{\gre@endofwordpenalty }%
      \xdef\gre@endofwordpenalty{10001}%
      \xdef\gre@endofsyllablepenaltysave{\gre@endofsyllablepenalty }%
      \xdef\gre@endofsyllablepenalty{10001}%
      \xdef\gre@endafterbarpenaltysave{\gre@endafterbarpenalty }%
      \xdef\gre@endafterbarpenalty{10001}%
      \xdef\gre@endafterbaraltpenaltysave{\gre@endafterbaraltpenalty }%
      \xdef\gre@endafterbaraltpenalty{10001}%
      \xdef\gre@endofelementpenaltysave{\gre@endofelementpenalty }%
      \xdef\gre@endofelementpenalty{10001}%
      \xdef\gre@hyphenpenaltysave{\gre@hyphenpenalty }%
      \xdef\gre@hyphenpenalty{10001}%
  \fi %
}

\def\greendnlbarea#1#2{%
  \xdef\gre@nlbinitialstate{\gre@nlbstate}%
  \ifnum#2=0\relax %
    \xdef\gre@nlbstate{0}%
  \else %
      \ifcase\gre@nlbstate %
        \xdef\gre@nlbstate{0}%
      \or %
        \xdef\gre@nlbstate{0}%
      \or %
        \xdef\gre@nlbstate{2}%
      \fi %
  \fi %
  % if grenlbstate is not 0, then nothing should happend
  \ifnum\gre@nlbstate=0\relax %
    \ifnum\gre@nlbinitialstate=0\else %
      \xdef\gre@nobreakpenalty{\gre@nobreakpenaltysave }%
      \xdef\gre@nolastlinepenalty{\gre@nolastlinepenaltysave}%
      \xdef\gre@endofwordpenalty{\gre@endofwordpenaltysave}%
      \xdef\gre@endofsyllablepenalty{\gre@endofsyllablepenaltysave}%
      \xdef\gre@endafterbarpenalty{\gre@endafterbarpenaltysave}%
      \xdef\gre@endafterbaraltpenalty{\gre@endafterbaraltpenaltysave}%
      \xdef\gre@endofelementpenalty{\gre@endofelementpenaltysave}%
      \xdef\gre@hyphenpenalty{\gre@hyphenpenaltysave}%
      \ifcase #1\relax %
        \gre@penalty{\gre@endofelementpenalty}%
      \or %
        \gre@penalty{\gre@endofsyllablepenalty}%
      \or %
    % end of score, no penalty needs to be added
      \fi %
    \fi %
  \fi %
}

\input gregoriotex-symbols.tex

%%%%%%%%
%% fonts
%%%%%%%%

\def\gretilde{%
  \ensuremath{\sim}%
  \relax %
}

\def\greitalic#1{%
  {\it #1}%
%  \relax %
}

\def\gresmallcaps#1{%
  {\sc #1}%
  \relax %
}

\def\greboldfont#1{%
  {\bf #1}%
  \relax %
}

\def\grebold#1{%
	\gre@warning{\protect\grebold\space is deprecated.\MessageBreak Use \protect\greboldfont\space instead}%
	\greboldfont{#1}%
}

\def\grett#1{%
  {\tt #1}%
  \relax %
}

\def\greul#1{%
  {#1}%
  \relax %
}

\def\grecolored#1{%
  {#1}%
  \relax %
}



% the default gregorio font
\xdef\gregoriofontname{greciliae}

\def\setgregoriofont#1{%
  \xdef\gregoriofontname{#1}%
  \ifnum\gre@factor=0\else %
    \gre@tempdimcount = \the\gre@factor %
    \multiply\gre@tempdimcount by 100000 %
    \global\font\gregoriofont="name:#1" at \the\gre@tempdimcount sp%
  \fi %
  \relax%
}

\xdef\gre@usestylefont{0}

% gregoriostylefont is the font used for additional glyphs
\def\gre@setstylefont{%
  \ifnum\gre@factor=0\else %
    \gre@tempdimcount = \the\gre@factor %
    \multiply\gre@tempdimcount by 100000\relax %
    \global\font\gregoriostylefont="name:greextra" at \the\gre@tempdimcount sp%
  \fi %
  \relax%
}

\def\grenormalstafflinesformat{%
  \relax %
}

\def\greadditionalstafflinesformat{%
  \relax %
}

\def\GreSetStaffLinesFormat#1{%
  \global\def\greadditionalstafflinesformat{#1\relax }%
  \global\def\grenormalstafflinesformat{#1\relax }%
  \relax %
}

\def\greinitialformat#1{%
  \font\grefontofinitial=pncr at 40pt%
  {\grefontofinitial #1}%
  \relax %
}

\def\grebiginitialformat#1{%
  \font\grefontofgrebiginitial=pncr at 80pt%
  {\grefontofgrebiginitial #1}%
  \relax %
}

\def\setgrefactor#1{%
  \ifnum\grefactor=0\relax %
    \changedimenfactor{1}{#1}%
  \else %
    \changedimenfactor{\grefactor}{#1}%
  \fi %
  \global\grefactor=#1\relax %
  \gresetverticalspaces %
  \gregeneratelines %
  \setgregoriofont{\gregoriofontname}%
  \ifnum\greusestylefont=1\relax %
  \gresetstylefont %
  \fi %
  \relax %
}

%%%%%%%%%%%%%%%%%%
%% score including
%%%%%%%%%%%%%%%%%%

% function that includes a score in TeX format
\def\greincludetexscore#1{%
  \input #1%
  \relax %
}

% function provided for backward compatibility
\let\includetexscore\greincludetexscore
\let\includescore\includetexscore

% TODO: comment
\def\greincludegabcscore#1{%
  \directlua{gregoriotex.include_gabc_score([[#1]])}%
  \relax %
}

\let\includegabcscore\greincludegabcscore

%%%%%%%%%%%%%%%%%%%%%%%%%%
%% some hyphen definitions
%%%%%%%%%%%%%%%%%%%%%%%%%%

% a zero-width hyphen, useful for fine tuning line endings. To input in gabc verb for example.
\def\grezerhyph{%
  \hbox to 0pt{%
  %-%
  \char\the\hyphenchar\font %
  \hss %
  }%
}

% a normal hyphen
\def\grenormalhyph{%
  %-%
  \char\the\hyphenchar\font %
}

% the definition that will be always used for end of lines hyphens in gregorio, except if one of the two before is explicitely used
\let\grehyph\grenormalhyph 

% two macros to change the definition of the hyphen:
\def\GreUseNormalHyphen{%
  \global\let\grehyph\grenormalhyph %
}

\def\GreUseZeroHyphen{
  \global\let\grehyph\grezerhyph %
}
