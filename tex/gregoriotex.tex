%GregorioTeX file.
%Copyright (C) 2007 Elie Roux <elie.roux@enst-bretagne.fr>
%
%This program is free software: you can redistribute it and/or modify
%it under the terms of the GNU General Public License as published by
%the Free Software Foundation, either version 3 of the License, or
%(at your option) any later version.
%
%This program is distributed in the hope that it will be useful,
%but WITHOUT ANY WARRANTY; without even the implied warranty of
%MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%GNU General Public License for more details.
%
%You should have received a copy of the GNU General Public License
%along with this program.  If not, see <http://www.gnu.org/licenses/>.

%%%%%%%%%%%%%%
%% basic start
%%%%%%%%%%%%%%

% factor is the factor with which you open you font (the number after the at). It will decide almost everything (spaces, etc.), so it is particularly important.
\newcount\factor
\factor=17

%%%%%%%%%%%%%%%%%%
%% vertical spaces
%%%%%%%%%%%%%%%%%%

% \stafflineheight is the height of a staff line
\newdimen\stafflineheight
\stafflineheight=1500 sp 
\multiply\stafflineheight by \the\factor 
% \interstafflinespace is the space between two lines of staff
\newdimen\interstafflinespace
\interstafflinespace=30000 sp 
\multiply\interstafflinespace by \the\factor 
% \interstafflinespace is the width of a line
\newdimen\linewidth \linewidth=\hsize 
% \stafflinewidth is the width of a line of staff, this can vary, for example at the first line
\newdimen\stafflinewidth \stafflinewidth=\linewidth 
% \staffheight is the total height of the staff : that is to say the four written lines
\newdimen\staffheight \staffheight=4\stafflineheight 
\advance\staffheight by 3\interstafflinespace

% vertical spaces
%the space above the lines
\newskip\spaceabovelines
%\spaceabovelines = 33000 sp plus 5000 sp minus 5000 sp
\spaceabovelines = 25000 sp plus 0 sp minus 0 sp
\multiply\spaceabovelines by \factor

%the space between the lines and the bottom of the text
\newskip\spacelinestext
\spacelinestext = 59500 sp plus 0 sp minus 0 sp
\multiply\spacelinestext by \factor

%the space beneath the text
\newskip\spacebeneathtext
\spacebeneathtext = 18000 sp plus 0 sp minus 0 sp
\multiply\spacebeneathtext by \factor

%constantglyphraise is the space between the 0 of the gragorian fonts and the effective 0 of the TeX score
% to calculate that, we take the bottom of the third line : it is at 200 in the fonts, and it must be at spacelinestext + spacebeneathtext + 2*interstafflinespace + 2*stafflineheight
\newdimen\constantglyphraise
\constantglyphraise = -22000 sp
\multiply\constantglyphraise by \the\factor
\advance\constantglyphraise\spacebeneathtext
\advance\constantglyphraise by \spacelinestext
\advance\constantglyphraise by \interstafflinespace
\advance\constantglyphraise by \interstafflinespace
\advance\constantglyphraise by \stafflineheight
\advance\constantglyphraise by \stafflineheight

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of text
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% \textlower is the height of the separation between the bottom line (which is invisible : for the notes which are very low) and the bottom of the text
\newdimen\textlower \textlower=\spacebeneathtext

%% macro that sets \temp to the width of its argument

\newbox\Tempwidth
\newdimen\tempwidth

\def\widthof#1{%
\setbox\Tempwidth=\hbox{#1}%
\tempwidth=\wd\Tempwidth%
\relax%
}

%% macro that typesets the text of the syllable, and sets \textaligncenter to the middle of the middle letters, it is needed because we align the note (often the middle of the note) with the middle of the middle letters
%% warning : textaligncenter is the width from the beginning of the letters to the middle of the middle letters

\newdimen\textaligncenter

\def\findtextaligncenter#1#2{%
\widthof{\textfont #1#2}%
\global\textaligncenter=\the\tempwidth %
\widthof{\textfont #2}%
\divide\tempwidth by 2 %
\global\advance\textaligncenter by -\the\tempwidth%
\relax%
}

% definition of the dash that we will use after the text if necessary
\def\gregoriotextdash{-}
\newdimen\gregoriotextdashwidth
\widthof{\gregoriotextdash}
\gregoriotextdashwidth=\tempwidth

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of the initial
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% box containing the initial, and dimen containing its width (and the width of the space after)
\newbox\Initial
\newdimen\initialwidth
\initialwidth=0pt

\def\initial#1{%
% we print the initial always at the same place, and the we print the Aboveinitialbox centered
% first we print the initial
\setbox\Initial=\hbox{\fontofinitial #1}%
\global\initialwidth=\the\wd\Initial%
\hskip\beforeinitialshift %
\raise\textlower\copy\Initial%
\hskip\afterinitialshift %
\global\advance\initialwidth by \afterinitialshift%
\global\advance\initialwidth by \beforeinitialshift %
% then we center the box above the initial, if there is one
\ifdim\wd\Aboveinitialbox=0 pt\relax %
\else %
\temp=\initialwidth %
\advance\temp by -\wd\Aboveinitialbox %
\divide\temp by 2 %
\hskip -\initialwidth %
\kern\temp %
\raise\aboveinitialraise\copy\Aboveinitialbox %
\kern\temp %
\setbox\Aboveinitialbox=\hbox{}%
\fi %
\relax%
}

\newbox\Aboveinitialbox %
\newdimen\aboveinitialraise %

\def\setfirstlineaboveinitial#1#2{%
\global\aboveinitialraise=\staffheight %
\global\advance\aboveinitialraise by \spacebeneathtext %
\global\advance\aboveinitialraise by \spacelinestext %
% we align the top of the box with the top of the line
\setbox\Aboveinitialbox=\hbox{#2}%
\global\advance\aboveinitialraise by -\ht\Aboveinitialbox %
\global\setbox\Aboveinitialbox=\hbox{#1}%
\relax %
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting the things above the initial
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\writemode#1{%
\relax%
}

\def\gregorianmode#1{%
\ifcase#1%
\or%
\writemode{I.}%
\or%
\writemode{II.}%
\or%
\writemode{III.}%
\or%
\writemode{IV.}%
\or%
\writemode{V.}%
\or%
\writemode{VI.}%
\or%
\writemode{VII.}%
\or%
\writemode{VIII.}%
\fi%
\relax%
}

\def\scorereference#1{%
\relax%
}

\def\beginscore{%
\drawlines%
\relax%
}

\def\commentary#1{%
\vbox{\hfill\hbox{#1}}%
\relax %
}

%\def\firstlineaboveinitial{%
%\hbox

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of the lines
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% maybe a good idea, but hard to exploit...
%\def\gscale#1{%
%\global\multiply#1 by \the\factor %
%\global\divide#1 by 10 %
%\relax%
%}

%% macro that draws the stafflines on the first line, it is different from others due to the initial that can take some place, without lines
\def\drawfirstlines{%
\advance\stafflinewidth by -\initialwidth%
\initialwidth=0pt%
\hbox to0pt{%
\vbox{%
\vskip\spaceabovelines %
\hrule height \stafflineheight width \stafflinewidth %
\kern\the\interstafflinespace %
\hrule height \stafflineheight width \stafflinewidth %
\kern\the\interstafflinespace %
\hrule height \stafflineheight width \stafflinewidth %
\kern\the\interstafflinespace %
\hrule height \stafflineheight width \stafflinewidth %
\vskip\spacelinestext %
\vskip\spacebeneathtext %
}%
\hss%
}%
\stafflinewidth=\linewidth%
\relax%
}

%% box containing the stafflines for other lines than the first
\newbox\Lines
\setbox\Lines=\hbox to0pt{%
\vbox{%
\vskip\spaceabovelines %
\hrule height \stafflineheight width \stafflinewidth %
\kern\the\interstafflinespace %
\hrule height \stafflineheight width \stafflinewidth %
\kern\the\interstafflinespace %
\hrule height \stafflineheight width \stafflinewidth %
\kern\the\interstafflinespace %
\hrule height \stafflineheight width \stafflinewidth %
\vskip\spacelinestext %
\vskip\spacebeneathtext %
}%
\hss%
\relax%
}

%% macro that draws the lines : starts by the first and then draws the lines of every line.
%% has to be called before drawing the key, after drawing the initial
\def\drawlines{%
\drawfirstlines %
%%localeleftbox is a primitive of Omega, it draws the same box at the beginning of new lines (here after the first)
\localleftbox{%
\copy\Lines %
}%
\relax%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of the clefs of the beginning of lines and custos
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% marcro to define the clef that will appear at the beginning of the lines
% the first argument is the type : f or c, and the second is the height

\def\setlinesclef#1#2{%
\localleftbox{%
\copy\Lines% draws the lines
\unkern %
\typekey{#1}{#2}{0}%
}%
\relax%
}

% macro that typesets the key
% arguments are : 
%% #1: the type of the key : c or f
%% #2: the line of the key (1 is the lowest)
%% #3: if we must use small key characters (inside a line) or not 0 if not inside, 1 if inside
\def\typekey#1#2#3{%
\ifcase#2 %
\or%
\calculateglyphraisevalue{c}{0}%
\or%
\calculateglyphraisevalue{e}{0}%
\or%
\calculateglyphraisevalue{g}{0}%
\or%
\calculateglyphraisevalue{i}{0}%
\fi%
\ifx c#1% we check if it is a c key
\ifcase#3%
\raise\glyphraisevalue\hbox{\gregorianfont \char 1\hskip\spaceafterlineclef}%
\or%
\raise\glyphraisevalue\hbox{\gregorianfont \char 3\hskip\spaceafterlineclef}%
\fi%
\else % we consider that it is a f key
\ifcase#3%
\raise\glyphraisevalue\hbox{\gregorianfont \char 2\hskip\spaceafterlineclef}%
\or%
\raise\glyphraisevalue\hbox{\gregorianfont \char 4\hskip\spaceafterlineclef}%
\fi%
\fi%
\relax%
}

% macro that writes the initial key, and sets the next keys to the same value

\def\setinitialclef#1#2{%
\typekey{#1}{#2}{0}%
\setlinesclef{#1}{#2}%
\relax%
}

% macro called when the key changes

\def\changeclef#1#2{%
\clefchangespace = 16500 sp plus 1650 sp minus 16500 sp%
\multiply\clefchangespace by \the\factor %
\hskip\clefchangespace %
\typekey{#1}{#2}{1}%
\hskip\clefchangespace %
\setlinesclef{#1}{#2}%
\relax%
}

% macro called when the key changes inside a syllable

\def\inchangeclef#1#2{%
\clefchangespace = 16500 sp plus 1650 sp minus 16500 sp%
\multiply\clefchangespace by \factor %
\hskip\clefchangespace %
\typekey{#1}{#2}{1}%
\hskip\clefchangespace %
\setlinesclef{#1}{#2}%
\relax%
}

% the argument is the height

\def\setcusto#1{%
\calculateglyphraisevalue{#1}{0}%
\localrightbox{%
\raise \glyphraisevalue%
\hbox{%
% we type a hskip and the we type the custo
\hskip\spacebeforecusto %
\gregorianfont %
\ifx a#1%
\char 62%
\fi%
\ifx b#1%
\char 60%
\fi%
\ifx c#1%
\char 61%
\fi%
\ifx d#1%
\char 60%
\fi%
\ifx e#1%
\char 61%
\fi%
\ifx f#1%
\char 60%
\fi%
\ifx g#1%
\char 61%
\fi%
\ifx h#1%
\char 60%
\fi%
\ifx i#1%
\char 61%
\fi%
\ifx j#1%
\char 63%
\fi%
\ifx k#1%
\char 64%
\fi%
\ifx l#1%
\char 63%
\fi%
\ifx m#1%
\char 65%
\fi%
}%
}%
\relax%
}

\def\removecusto{%
\localrightbox{}%
\relax%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of the different glyphs
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% \glyphraisevalue is the value of which we must raise one glyph (that will vary with every glyph)
\newdimen\glyphraisevalue 

% \addedraisevalue is for the vertical episema and the puncta
\newdimen\addedraisevalue

% a temporary count
\newcount\tempcount

% a boolean : 0 if the note is not a line, else 1
\newcount\isonaline

% a very useful macro : it determines the good height of a glyph : the argument is the "number" where the glyph should be : 4 for the first line, 6 for the second, etc.
% the second argument is for the cases of signs: for example if the note is on a line, the punctummora will be above, and the auctus duplex beneath. the possible values are:
%% 0: no modification
%% 1: puts the value on the interline just above if it is on a line
%% 2: puts the value on the interline just beneath if it is on a line
%% 3: case of the vertical episemus, which is not placed at the same place if the corresponding note is on a line or not
%% 4: case of the punctum mora, for the same reason
\def\calculateglyphraisevalue#1#2{%
\global\isonaline=\number 0%
\ifx a#1%
\global\tempcount=\number 1%
\fi%
\ifx b#1%
\global\tempcount=\number 2%
\global\isonaline=1 %
\fi%
\ifx c#1%
\global\tempcount=\number 3%
\fi%
\ifx d#1%
\global\tempcount=\number 4%
\global\isonaline=1 %
\fi%
\ifx e#1%
\global\tempcount=\number 5%
\fi%
\ifx f#1%
\global\tempcount=\number 6%
\global\isonaline=1 %
\fi%
\ifx g#1%
\global\tempcount=\number 7%
\fi%
\ifx h#1%
\global\tempcount=\number 8 %
\global\isonaline=1 %
\fi%
\ifx i#1%
\global\tempcount=\number 9%
\fi%
\ifx j#1%
\global\tempcount=\number 10%
\global\isonaline=1 %
\fi%
\ifx k#1%
\global\tempcount=\number 11%
\fi%
\ifx l#1%
\global\tempcount=\number 12%
\global\isonaline=1 %
\fi%
\ifx m#1%
\global\tempcount=\number 13%
\fi%
% if the note is on a line, we change its height
\ifcase\isonaline%
\or%
\ifcase#2 %
\or% 1
\advance\tempcount by 1%
\or% 2
\advance\tempcount by -1%
\or% 3
\advance\tempcount by -1%
\or% 4
\advance\tempcount by 1%
\fi%
\fi%
\advance\tempcount by -7 %
\glyphraisevalue = 15750 sp %
\multiply\glyphraisevalue by \the\factor %
\multiply\glyphraisevalue by \the\tempcount %
\addedraisevalue= 0 sp%
\ifcase#2 % 
\or\or\or%3: if it is a vertical episemus on a line, we shift it a bit higher, so that it's more beautiful
\ifnum\isonaline=1%
\addedraisevalue=350 sp%
\multiply\addedraisevalue by \the\factor %
\advance\glyphraisevalue by \addedraisevalue %
\fi %
\or% 4: if it is a punctum mora on a line, we shift it a bit lower, for the same reason
\ifnum\isonaline=1%
\addedraisevalue=-400 sp%
\multiply\addedraisevalue by \the\factor %
\advance\glyphraisevalue by \addedraisevalue %
\fi%
\fi%
\multiply\addedraisevalue by \the\factor %
\advance\glyphraisevalue by \addedraisevalue %
\advance\glyphraisevalue by \constantglyphraise %
\global\tempcount=0%
\global\isonaline=0%
\relax%
}

% count that tells us if the current glyph is the first glyph or not. It it is the case, we determine
\newcount\firstglyph

\newcount\firstnote
\newcount\secondnote
\newcount\thirdnote
\newcount\fourthnote
\newcount\glyphnumber
\newcount\glyphnumbertemp
\newcount\interval
\newcount\notetemp

\def\assignnote#1#2{%
\ifcase#1%
\or%
\global\firstnote=#2%
\or%
\global\secondnote=#2%
\or%
\global\thirdnote=#2%
\or%
\global\fourthnote=#2%
\fi%
\relax%
}

\def\notetonumber#1#2{%
\ifx a#1%
\assignnote{#2}{1}%
\fi%
\ifx b#1%
\assignnote{#2}{2}%
\fi%
\ifx c#1%
\assignnote{#2}{3}%
\fi%
\ifx d#1%
\assignnote{#2}{4}%
\fi%
\ifx e#1%
\assignnote{#2}{5}%
\fi%
\ifx f#1%
\assignnote{#2}{6}%
\fi%
\ifx g#1%
\assignnote{#2}{7}%
\fi%
\ifx h#1%
\assignnote{#2}{8}%
\fi%
\ifx i#1%
\assignnote{#2}{9}%
\fi%
\ifx j#1%
\assignnote{#2}{10}%
\fi%
\ifx k#1%
\assignnote{#2}{11}%
\fi%
\ifx l#1%
\assignnote{#2}{12}%
\fi%
\ifx m#1%
\assignnote{#2}{13}%
\fi%
\relax%
}

% not working yet, do not use
\def\tor#1#2#3{%
\notetonumber{#1}{1}%
\notetonumber{#2}{2}%
\notetonumber{#3}{3}%
\interval=\secondnote%
\advance\interval by -\firstnote %
\multiply\interval by 25 %
\tempnote=\secondnote%
\advance\tempnote by -\thirdnote %
\advance\interval by \tempnote %
\advance\interval by 28672 %
\glyph{\char \the\interval}{#1}{#3}{0}%
\relax%
}

% the width of the last glyph, including the width of the text which is after
%\newdimen\lastglyphwidth
% the width of the text which is after the glyph
%\newdimen\additionalwidth

% macro to typeset the glyph. attributes are :
% #1: character : the character that it must call
% #2: height : the height it must be raised : can be negative (must be calculated by a preprocessor)
% #3: height of the next note : we define the custo with that
% #4: type : the type of glyph, to determine the aligncenter; can be :
%%%%% 0 : one-note glyph or more than two notes glyph except porrectus : here we must put the aligncenter in the middle of the first note
%%%%% 1 : two notes glyph (podatus is considered as a one-note glyph) : here we put the aligncenter in the middle of the glyph
%%%%% 2 : porrectus : has a special align center
%%%%% 3 : initio-debilis : same as 1 but the first note is much smaller
%%%%% 4 : case of a glyph starting with a quilisma
%%%%% 5 : case of a glyph starting with an oriscus
%%%%% 6 : case of a punctum inclinatum
%%%%% 7 : case of a stropha
%%%%% 8 : flexus with an ambitus of one
%%%%% 9 : flexus deminutus
\def\glyph#1#2#3#4{%
\calculateglyphraisevalue{#2}{0}%
\setbox\Tempwidth=\hbox{\gregorianfont #1}%
\tempwidth=\wd\Tempwidth%
\raise \glyphraisevalue%
\copy\Tempwidth%
\ifnum\the\endofscore=0 %
\setcusto{#3}%
\fi %
\ifnum\the\firstglyph=1% we check if it is the first glyph
\findnotesaligncenter{#4}%
\global\firstglyph=0%
\fi%
%\lastglyphwidth=\tempwidth%
\relax%
}

% notes align center is the point of alignment for the notes
\newdimen\notesaligncenter

% this function is quite simple, it just sets \Tempwidth with a box of the good width, watch the next function for the complete thing
% we define the different alignments possible, of course they depend on the font
% the first 10 (0-9) possible values are the same as in glyph
%%%%% 0 : one-note glyph or more than two notes glyph except porrectus : here we must put the aligncenter in the middle of the first note
%%%%% 1 : two notes glyph (podatus is considered as a one-note glyph) : here we put the aligncenter in the middle of the glyph
%%%%% 2 : porrectus : has a special align center
%%%%% 3 : initio-debilis : same as 1 but the first note is much smaller
%%%%% 4 : case of a glyph starting with a quilisma
%%%%% 5 : case of a glyph starting with an oriscus
%%%%% 6 : case of a punctum inclinatum
%%%%% 7 : case of a stropha
%%%%% 8 : flexus with an ambitus of one
%%%%% 9 : flexus deminutus
%%%%% 10 : virgula
%%%%% 11 : divisio minima, minor and maior
%%%%% 12 : divisio finalis
% there is a tricky here : if notesaligncenter is not 0, it means that there is a flat before, so we simply add notes aligncenter
\def\findsimplenotesaligncenter#1{%
\ifcase#1%
%case of punctum
\global\setbox\Tempwidth=\hbox{\gregorianfont \char 17}%
\or%
%case of flexus
\global\setbox\Tempwidth=\hbox{\gregorianfont \char 4098}%
\or%
%case of porrectus (we consider it to have the same alignment as punctum)
\global\setbox\Tempwidth=\hbox{\gregorianfont \char 17}%
\or%
%case of a initio debilis
\global\setbox\Tempwidth=\hbox{\gregorianfont \char 13}%
\or %
%case of a quilisma
\global\setbox\Tempwidth=\hbox{\gregorianfont \char 26}%
\or %
%case of an oriscus
\global\setbox\Tempwidth=\hbox{\gregorianfont \char 28}%
\or %
%case of a punctum inclinatum
\global\setbox\Tempwidth=\hbox{\gregorianfont \char 19}%
\or %
%case of a stropha
\global\setbox\Tempwidth=\hbox{\gregorianfont \char 20}%
\or %
% case of flexus with ambitus of one
\global\setbox\Tempwidth=\hbox{\gregorianfont \char 4097}%
\or %
% case of flexus deminutus
\global\setbox\Tempwidth=\hbox{\gregorianfont \char 4225}%
\or %
% case of virgula
\global\setbox\Tempwidth=\hbox{\gregorianfont \char 9}%
\or %
% case of divisio minima, minor, maior
\global\setbox\Tempwidth=\hbox{\gregorianfont \char 13}%
\or %
% case of divisiofinalis
\global\setbox\Tempwidth=\hbox{\divisiofinalissymbol}%
\fi%
\relax%
}

% the "hat" function, that calls the simple function with the good argument, according to the fact that it's a flat, natural, etc.
% warning: the behaviour of all this is quite difficult to understand: this function is called with simple arguments (between 0 and 20) by the glyph function. In this case we add the align center of the argument to notesaligncenter ; and notesaligncenter can be already set to something by flat and natural.
\def\findnotesaligncenter#1{%
\findsimplenotesaligncenter{#1}%
\temp=\wd\Tempwidth %
\divide\temp by 2\relax %
\global\advance\notesaligncenter by \temp %
\relax %
}

% this is the function that we call when we try to determine the next aligncenter of the notes. In this case we call this function with normal arguments if there is no flat nor natural ; we call it with argument + 20 if there is a flat and argument + 40 if there is a natural... I know this is dirty... but... this is TeX...
\def\findnextnotesaligncenter#1{%
\ifnum#1<20\relax %
\findsimplenotesaligncenter{#1}%
\temp=\wd\Tempwidth %
\divide\temp by 2\relax %
\global\notesaligncenter=\temp %
\else %\ifnum#1<20
\tempcount=#1 %
\ifnum#1<40\relax%
\advance\tempcount by -20\relax %
\findsimplenotesaligncenter{\tempcount}%
\temp=\wd\Tempwidth %
\divide\temp by 2\relax %
\setbox\Tempwidth=\hbox{\gregorianfont \char 6}%
\else%\ifnum#1<40
\advance\tempcount by -40\relax %
\findsimplenotesaligncenter{\tempcount}%
\temp=\wd\Tempwidth %
\divide\temp by 2\relax %
\setbox\Tempwidth=\hbox{\gregorianfont \char 7}%
\fi %
\advance\temp by \wd\Tempwidth %
\global\notesaligncenter=\temp %
\global\tempcount=0\relax %
\fi %
\relax %
}

% box that we will use to determine the width of the notes, to determine wether we typeset a - or not after the letters
\newbox\Syllablenotes
\def\syllablenotes#1{%
\setbox\Syllablenotes=\hbox{#1}%
\relax%
}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of the signs
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% a function to typeset a punctum mora, the argument is the letter of the height of the punctum mora
% if the second argument is one, we the go back to the end of the punctum
\def\punctummora#1#2{%
\ifnum#2=1\relax %
\kern\spacebeforesigns %
\else %
\hskip\spacebeforesigns%
\fi %
\calculateglyphraisevalue{#1}{4}%
\raise \glyphraisevalue \hbox{\gregorianfont \char 14}%
\ifnum#2=1\relax %
\setbox\Tempwidth=\hbox{\gregorianfont \char 14}%
\temp=\wd\Tempwidth %
\advance\temp by \spacebeforesigns %
\kern -\temp %
\fi %
\relax%
}

% a function to typeset a augmentum duplex, the argument is the letter of the height of the augmentum duplex
\def\augmentumduplex#1{%
\hskip\spacebeforesigns%
\calculateglyphraisevalue{#1}{2}%
\raise \glyphraisevalue \hbox{\gregorianfont \char 15}%
\relax%
}

\newbox\Tempsign
\newdimen\tempsignwidth

%3: si on revient au début ou pas : 0 on revient au début
% a macro to help typesetting vertical episemus. The third argument is 0 when we go back to the beginning of the glyph. If it is 2, it means that we must go back first of width #1, and then forward of #2. If it is 1, it means that we only need to go back of #2. It is very hard to understand, sorry.
\def\vepisemusaux#1#2#3{%
\setbox\Tempsign=\hbox{\gregorianfont #2}%
\tempsignwidth=\wd\Tempsign%
\divide\tempsignwidth by 2 %
\ifcase#3%
\advance\tempwidth by -\tempsignwidth %
\or%
\tempwidth=\tempsignwidth %
\or%
\setbox\Tempsign=\hbox{\gregorianfont #1}%
\tempwidth=\wd\Tempsign %
\advance\tempwidth by -\tempsignwidth %
\fi%
% then we draw the sign
\setbox\Tempsign=\hbox{\gregorianfont \char 33}%
% we set tempwidth to half a punctum malus half the sign width, so that the centers are aligned
\tempsignwidth=\wd\Tempsign %
\divide\tempsignwidth by 2 %
\advance\tempwidth by \tempsignwidth %
\kern -\tempwidth%
\raise \glyphraisevalue \copy\Tempsign %
% and finally we go back to the end of the glyph, where we were first
\advance\tempwidth by -2\tempsignwidth %
\kern \tempwidth%
\relax%
}

% a function to typeset a vertical episemus. The firts argument is the letter of the height of the episemus (not the height of the note it corresponds to. This function must be called after a call to \glyph. The second argument is the type of glyph it was, more precisely the kind of space there is between the end (or in special cases the beginning) of the glyph and the place where we will typeset the episemus. The possible values are:
%% 0: the episemus will be typeset in the middle of the last note, which is a standard punctum (works with pes)
%% 1: the same, but the last note is a deminutus
%% 2: the episemus is typeset in the middle of the note before the last note, which is a standard punctum
%% 3: idem, but the note is the note preceding a deminutus
%% 4: the note before the note before the last note (for torculus resupinus)
%% 5: idem, but when the two last notes are a deminutus
%% 6: the first note, if it is a standard punctum
%% 7: the first note, if it is an initio debilis
%% 8: the first note, if it is a porrectus or a torculus resupinus
%% 9: the last note, if it is a punctum inclinatum
%% 10: idem, if it is a punctum inclinatum debilis
%% 11: idem, if it is a stropha
%% 12: idem, with a quilisma
%% 13: idem, with an oriscus
%% 14: idem of 2, but with ambitus of 1 between the two last notes (so no link between them) 
\def\vepisemus#1#2{%
\calculateglyphraisevalue{#1}{3}%
\ifcase#2 %
%case 0
\vepisemusaux{0}{\char 17}{0}%
\or%
%case 1
\vepisemusaux{0}{\char 13}{0}%
\or%
%case 2
% a kind of flexus, it has the good width
\vepisemusaux{\char 4098}{\char 17}{1}%
\or%
%case 3
% in order to go to the good place, we first make a kern of - the glyph before deminutus, which has the same width as a standard flexus deminutus
\vepisemusaux{0}{\char 4225}{1}%
\or%
%case 4
% is a torculus, it has the good width
\vepisemusaux{\char 14434}{\char 17}{1}%
\or%
%case 5
% is a torculus deminutus, it has the good width
\vepisemusaux{\char 14859}{\char 17}{1}%
\or%
%case 6
\vepisemusaux{0}{\char 17}{2}%
\or%
%case 7
\vepisemusaux{0}{\char 13}{2}%
\or%
%case 8, in which we do (for now) the same as case 6
\vepisemusaux{0}{\char 17}{2}%
\or%
%case 9
\vepisemusaux{0}{\char 19}{0}%
\or%
%case 10
\vepisemusaux{0}{\char 32}{0}%
\or%
%case 11
\vepisemusaux{0}{\char 20}{0}%
\or%
%case 12
\vepisemusaux{0}{\char 26}{0}%
\or%
%case 13
\vepisemusaux{0}{\char 27}{0}%
\or%
%case 14
\vepisemusaux{\char 4097}{\char 17}{1}%
\fi%
\relax%
}


% a macro that will help in the typesetting of a horizontal episemus, the first argument is a glyph that have the same width as the width between the end of the glyph and the beginning of the episemus, and the second argument is the character of the episemus. If the third argument is 0, we go directly to the beginning of the glyph, else we don't change anything
\def\hepisemusaux#1#2#3{%
\ifnum#3=0%
%remember, \tempwidth has the value of the last glyph width (cool isn't it?)
\else%
\setbox\Tempsign=\hbox{\gregorianfont #1}%
\tempwidth=\wd\Tempsign%
\fi%
% then we draw the sign, and go back to the beginning of the sign
\setbox\Tempsign=\hbox{\gregorianfont \char #2}%
% we set tempwidth to half a punctum malus half the sign width, so that the centers are aligned
\tempsignwidth=\wd\Tempsign %
\kern -\tempwidth%
\raise \glyphraisevalue \copy\Tempsign %
% and finally we go back to the end of the glyph, where we were first
\advance\tempwidth by -\tempsignwidth %
\kern \tempwidth%
\relax%
}

% a function to typeset a horizontal episemus. The firts argument is the letter of the height of the episemus (not the height of the note it corresponds to. This function must be called after a call to \glyph. The second argument is the type of glyph it was, more precisely the kind of space there is between the end (or in special cases the beginning) of the glyph and the place where we will typeset the episemus. The possible values are:
%% 0: the episemus will be typeset at the beginning of the last note, which is a standard punctum (works with pes)
%% 1: the same, but the last note is a deminutus
%% 2: the episemus is typeset at the beginning of the note before the last note, which is a standard punctum
%% 3: idem, but the note is the note preceding a deminutus
%% 4: the note before the note before the last note (for torculus resupinus)
%% 5: idem, but when the two last notes are a deminutus
%% 6: the first note, if it is a standard punctum
%% 7: the first note, if it is an initio debilis
%% 8: the two first notes, if it is a porrectus
%% 9: the two first notes, if it is a porrectus flexus
% the third argument is a bit particular, it is the ambitus of the porrectus or porrectus flexus if the second argument is 8 or 9, otherwise it is useless
%% 10: the last note, if it is a punctum inclinatum
%% 11: idem, if it is a punctum inclinatum debilis
%% 12: idem, if it is a stropha
%% 13: idem, with a quilisma
%% 14: idem, with an oriscus
%%% cases for the special spaces between the notes (for ambitus of one)
%% 15: same of 2
\def\hepisemus#1#2#3{%
\calculateglyphraisevalue{#1}{1}%
\ifcase#2 %
%case 0
\hepisemusaux{\char 17}{40}{1}%
\or%
%case 1
\hepisemusaux{\char 13}{42}{1}%
\or%
%case 2
% a kind of flexus, it has the good width
\hepisemusaux{\char 4098}{40}{1}%
\or%
%case 3
% in order to go to the good place, we first make a kern of - the glyph before deminutus, which has the same width as a standard flexus deminutus
\hepisemusaux{\char 4225}{40}{1}%
\or%
%case 4
% a torculus, it has the good width
\hepisemusaux{\char 14343}{40}{1}%
\or%
%case 5
% \char 29190 is a torculus deminutus, it has the good width
\hepisemusaux{\char 14859}{40}{1}%
\or%
%case 6
\hepisemusaux{0}{40}{0}%
\or%
%case 7
%we assume that the initio-debilis has the same width as a punctum deminutus
\hepisemusaux{0}{41}{0}%
\or%
%case 8
\ifcase#3%
\or%
\hepisemusaux{0}{45}{0}%
\or%
\hepisemusaux{0}{46}{0}%
\or%
\hepisemusaux{0}{47}{0}%
\or%
\hepisemusaux{0}{48}{0}%
\or%
\hepisemusaux{0}{49}{0}%
\fi%
\or%
%case 9
\ifcase#3%
\or%
\hepisemusaux{0}{50}{0}%
\or%
\hepisemusaux{0}{51}{0}%
\or%
\hepisemusaux{0}{52}{0}%
\or%
\hepisemusaux{0}{53}{0}%
\or%
\hepisemusaux{0}{54}{0}%
\fi%
\or%
%case 10
\hepisemusaux{\char 19}{43}{1}%
\or%
%case 11
\hepisemusaux{\char 32}{44}{1}%
\or%
%case 12
\hepisemusaux{\char 20}{45}{1}%
\or%
%case 13
\hepisemusaux{\char 26}{56}{1}%
\or%
%case 14
\hepisemusaux{\char 27}{47}{1}%
\or%
%case 15
\hepisemusaux{\char 4097}{40}{1}%
\fi%
\relax%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of glyphs and notes together
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% a dimen that will contain the difference between the end of the text and the end of the notes for the previous syllable (if we are in the same word) : positive if notes go further than text. We will use it for space adjustment between syllables of the same word

\newdimen\enddifference 

% a dimen that will contain the enddifference of the previous glyph

\newdimen\previousenddifference 

% \begindifference is the difference between the begginning of the text and the beginning of the notes. Warning : it can be negative.

\newdimen\begindifference

\newdimen\temp

% box that will contain the text of the syllable

\newbox\Syllabletext

% count that will be 0 if in the last text there was no dash (or if it is the beginning of a word, and 1 if there was
%\newcount\previousdash

\newcount\firstsyllableofword
\firstsyllableofword=1

%\attributedef\potentialdash 1
%\potentialdash=1
%\attributedef {potentialdash} 16

% \zerowidthdash is a special character that will be treated by lua after the linebreak algorithm, see lua part of the file for more details
%\newbox\Zerowidthdash
%\setbox\Zerowidthdash=\hbox to 0pt{\hbox to 1pt{}}

% we specify if it is the last syllable of the score with that value
\newcount\endofscore

%% general macro : it will typeset the syllable : arguments are :
% #1 : the first letters of the syllable, that don't count for the alignment
% #2 : the middle letters of the syllable, we must align in the middle of them
% #3 : the end letters, they don't count
% #4 : end of word : if it is 0 it means it is not an end of word, if it is 1 it is
% TODO: find another system for the end syllable
%% #5 (not used anymore) : beggining of word : if it is 0 it means it is not a beginning of word, if it is 1 it is
% #8 : glyphs : all the notes
% the three next parameters are to put an hyphen if necessary, they can be empty for end of words
% #5 : first letters of the next syllable 
% #6 : middle letters of the next syllabel
% #7 : alignment type of the first next glyph
%% with a special option for #7 : if it is a bar, we don't put a space at the end
%% at the end we wall \endofword or \endofsyllable with #7, to reduce the space in case of a flat or natural
\def\syllable#1#2#3#4#5#6#7#8{%
\firstglyph=1 %
\findtextaligncenter{#1}{#2}% we first get the width between the alignment point and the end of the syllable
\syllablenotes{#8}% we put the notes in a box, so that we have the width of it
% now we calculate the begin difference, that is to say \notesaligncenter - \textaligncenter
\begindifference=\notesaligncenter %
\advance\begindifference by -\textaligncenter %
% then we do a kind of trick to separate more the notes of two different syllables : we put a space if we are in the same word (enddifference!=0) if necessary
% there are two cases according to the sign of enddifference
% and we do it only if it is not the first syllable of a word
% but we must not do it when there is a bar before... so when there is a bar enddifference = 0
\ifnum\firstsyllableofword=0 %
\ifdim\enddifference>0pt%
\temp=\intersyllablespace %
\advance\temp by \begindifference %
\else %\enddifference<0
\temp=\intersyllablespace %
\advance\temp by \begindifference %
\advance\temp by \enddifference %
\fi % \ifdim\enddifference>0pt
\ifnum\firstisalteration=1\relax %
\advance\temp by \beforealterationspace %
\global\firstisalteration=0\relax %
\fi % \ifnum\firstisalteration=1
\ifdim\temp>0pt %
\hskip\temp %
\fi %
\fi %
%\potentialdash=2 %
\setnextbegindifference{#5}{#6}{#7}%
\setbox\Syllabletext=\hbox{\textfont#1#2#3}%
\setenddifference{\wd\Syllablenotes}{\wd\Syllabletext}{\textaligncenter}{\notesaligncenter}{1}%
%\potentialdash=1 %
\ifcase#4 %
% we enter here if the end of word is 0, so we must determine if we need to type the gragorio dash here
%
% we set temp to the additional space that will be needed before the next syllable
%\ifdim\enddifference>0pt%
\temp=\enddifference %
\advance\temp by \intersyllablespace %
\advance\temp by \nextbegindifference %
%\else %\enddifference<0
%\temp=\intersyllablespace %
%\advance\temp by \nextbegindifference %
%\advance\temp by \enddifference %
%\fi %
%\temp=\intersyllablespace %
%\advance\temp by -\nextbegindifference %
%\advance\temp by \enddifference %
%
% then we compare it with \maximumspacewithoutdash, if it is larger, we add a dash
%
\ifdim\temp>\maximumspacewithoutdash %
%\potentialdash=2 %
\setbox\Syllabletext=\hbox{\textfont #1#2#3%
\gregoriotextdash%
}%
\setenddifference{\wd\Syllablenotes}{\wd\Syllabletext}{\textaligncenter}{\notesaligncenter}{0}%
\fi%
\fi%
% then we reuse temp, we assign to it the \begindifference, but only if it is positive, else it is 0
\ifdim\begindifference > 0 pt%
\kern \begindifference %
\fi%
\raise\textlower \copy\Syllabletext %
\kern -\wd\Syllabletext %
\kern -\begindifference %
#8% we do that instead of \unhbox\Syllablnotes, because it would not set the \localrightbox
\ifdim\the\enddifference <0pt%
%% important, else we are not really at the end of the syllable
\kern -\enddifference %
\fi%
%% then we call end of syllable or end of word, but only if the next syllable is not a bar, that is to say, the number is between 10 and 19. TeX is a shitty language, so we do a dirty workaround to make a and in the if.
\ifnum#7>9\relax %
\ifnum#7<20\relax %
\endbeforebar %
\global\firstsyllableofword=1 %
\else %
\shittytexworkaround{#4}%
\fi %
\else %
\shittytexworkaround{#4}%
\fi%
\global\notesaligncenter= 0 pt\relax % very important, see flat and natural
\relax%
}

% not a very beautiful name... maybe I should change it... the only reason of this function is that TeX can't have and in if
% #1 is the #4 of syllable
\def\shittytexworkaround#1{%
\ifnum\lastoflinecount=1\relax %
\global\lastoflinecount=0\relax %
\grenewline %
\ifcase#1 %
\global\firstsyllableofword=0 %
\or%
\global\firstsyllableofword=1 %
\fi%
\else %\ifnum\lastoflinecount=1\relax %
\ifcase#1 %
\endofsyllable%
\global\firstsyllableofword=0 %
\or%
\endofword%
\global\firstsyllableofword=1 %
\fi%
\fi%
}
%skip needed for the barsyllable macro
\newskip\skipone

%a macro to typeset a syllable with only a bar inside
\def\barsyllable#1#2#3#4#5#6#7#8{%
% the algorithm of this function is *extremely* complex, and has been much painful to write... good luck to understand.
% the main goal is, when there is no text under the bar, to put the bar in the middle of the space between the last note of the prefious syllable and the first note of the next syllable. But there are limits : a bar cant go very far above text. For example if there is nuncncncncn with a punctum on the u, the bar can't go above the fourth n, the most far position is the position where the end of the bar is above the end of the word. The same limitation applies for the syllable after the bar.
% there are two different cases that have almost nothing in common : the case where there is something written under the bar, and the case where there is nothing.
% first of all we need to calculate previousenddifference, begindifference, enddifference and nextbegindifference.
% here we consider that #1 is : (or other stuff) that goes between the last syllable and *, so we don't center on it
\findtextaligncenter{}{#2}%
\setbox\Syllabletext=\hbox{\textfont #1#2#3}%
\syllablenotes{#8}%
\notesaligncenter=\wd\Syllablenotes%
\divide\notesaligncenter by 2\relax %
\begindifference=\notesaligncenter %
\advance\begindifference by -\textaligncenter %
\setenddifference{\wd\Syllablenotes}{\wd\Syllabletext}{\textaligncenter}{\notesaligncenter}{1}%
\setnextbegindifference{#5}{#6}{#7}%
% then we check if there is something to write
\ifdim\wd\Syllabletext = 0 pt\relax %
% the most difficult case : when there is nothing to write
% first we need to determine the real space that there will be between the notes. Here again it is not so simple... let's consider these two kinds of spaces : 
%% 1/ the minimal space between a note and the bar + the width of the bar + the minimal space between the bar and the note (that's the global idea, in fact there are nuances) : we assign skipone to it
%% 2/ enddifference + begindifference + space between notes and word : we assign temp to it
\skipone=\notebarspace %
\advance\skipone by \notebarspace %
\advance\skipone by \wd\Syllablenotes %
% now let's get temp
\ifdim\nextbegindifference < 0 pt%
\temp=-\nextbegindifference %
\else %
\temp=0 pt%
\fi %
\ifdim\previousenddifference < 0 pt%
\advance\temp by -\previousenddifference %
\advance\temp by \interwordspacetext % in fact it is the max between interwordspacetext and interwordspacetextnotes
\else %
\advance\temp by \interwordspacenotestext % in fact it is the max between interwordspacenotestext and interwordspacenotes
\fi%
% we take the max of it, then we divide it by two and we substract half of the width of the bar
\ifdim\skipone <\temp %
\skipone=\temp %
\fi %
\divide\skipone by 2\relax %
\temp=\wd\Syllablenotes %
\divide\temp by 2\relax %
\advance\skipone by -\temp %
% now we have our skipone
\temp=\skipone %
\ifdim\previousenddifference < 0 pt%
\advance\temp by \previousenddifference %
\fi %
\ifdim\temp > -\wd\Syllablenotes %
\kern\temp %
\else %
\kern -\wd\Syllablenotes %
\fi %
#8%
\ifdim\temp < -\wd\Syllablenotes %
\ifdim\nextbegindifference > 0 pt%
\hskip\interwordspacetextnotes %
\else % \ifdim\nextbegindifference > 0 pt
\hskip\interwordspacetext %
\fi %
\else % \ifdim\temp < -\wd\Syllablenotes
%\temp=\wd\Syllablenotes %
%\divide\temp by 2\relax %
%\kern -\temp %
\temp=\skipone %
\ifdim\nextbegindifference < 0 pt%
\advance\temp by \nextbegindifference %
\fi %
\ifdim\temp > -\wd\Syllablenotes %
\kern\temp %
\else % \ifdim\temp > -\wd\Syllablenotes %
\hskip -\wd\Syllablenotes %
\fi %
\fi %
% then the most simple : the case where there is something to write under the bar. We just need to adjust the spaces.
\else %ifdim\wd\hbox{#1#2#3}=0
% I'm a little lazy for now, I won't make the usual mountain of ifs... TODO: use different spaces
\skipone=\textbartextspace %
% same code as in syllable
%\temp=\begindifference %
%%%\ifdim\temp > 0 pt %
%%%\advance\skipone by \temp %
%%%\fi%
\kern \skipone %
% we add the width of #1 to the space because, remember, #1 has a special alignment with bars
\setbox\Syllabletext=\hbox{#1}%
% if #1 is not nul, we put #1 in the middle of the last space
\ifdim\wd\Syllabletext= 0 pt%
\else %\ifdim\wd\Syllabletext= 0 pt
\divide\skipone by 2 %
\hskip -\skipone %
\raise\textlower \copy\Syllabletext %
\hskip\skipone %
\fi %
\setbox\Syllabletext=\hbox{#2#3}%
\raise\textlower \copy\Syllabletext %
\kern -\wd\Syllabletext %
\kern -\begindifference %
#8% 
\ifdim\the\enddifference <0pt%
%% important, else we are not really at the end of the syllable
\kern -\enddifference %
\fi%
% end of same code as syllable
\hskip\textbartextspace % same as above, we should make some if to determine the exact space...
%and that's it !!
\fi%
\firstsyllableofword=1 %
\ifnum\lastoflinecount=1\relax %
\global\lastoflinecount=0\relax %
\grenewline %
\fi %
\global\notesaligncenter= 0 pt\relax % very important, see flat and natural
\relax%
}

%nextbegindifference is the begindifference of the next syllable
\newskip\nextbegindifference
\newskip\tempskip %TODO : couldn't we use another existing temp* ?

% macro to set \nextbegindifference
%% 1 : the first letters of the next syllable
%% 2 : the middle letters of the next syllable
%% 3 : the type of notes alignment
\def\setnextbegindifference#1#2#3{%
%to prevent the pollution of the normal values, we stock them into a temp value
\tempskip=\textaligncenter %
\findtextaligncenter{#1}{#2}%
\global\nextbegindifference=-\textaligncenter %
\global\textaligncenter=\the\tempskip %
\tempskip=\notesaligncenter %
\findnextnotesaligncenter{#3}% idem
\global\advance\nextbegindifference by \the\notesaligncenter %
\global\notesaligncenter=\tempskip %
\relax %
}

% macro to set \enddifference (defined above) to \wd\Syllablenotes - (\wd\Syllabletext - \textaligncenter) - \notesaligncenter
% \enddifference will be positive if text go further than the notes, and negative in the other case
% arguments are :
% #1: \wd\Syllablenotes : the total width of the notes
% #2: \wd\Syllabletext : the total width of the text
% #3: \textaligncenter (defined above)
% #4: \notesaligncenter (defined above too)
% #5: if we have to set previousenddifference or not
\def\setenddifference#1#2#3#4#5{%
\ifcase#5\or %
\global\previousenddifference=\the\enddifference %
\fi %
\global\enddifference=#1%
\global\advance\enddifference by -#2%
\global\advance\enddifference by #3%
\global\advance\enddifference by -#4%
\relax%
}

%% Finally we don't use it, because syllables never cross, I keep it, just in case...
% macro that will calculate the shift that we apply at the beginning, to combine two syllables of the same note
% arguments are :
% #1: \begindifferrence, defined above
% but the macro also uses \previousenddifference, \previousdash (not yet)
%\def\setsyllableshift#1{%
%\the\previousenddifference %
%\ifdim\previousenddifference >0pt %
%\hskip\intersyllablenotesspace %
%\ifdim-#1<\previousenddifference %
%\kern #1%
%test1 %
%\else%
%\kern -\previousenddifference %
%test2%
%\fi%
%\else%
% we test if begin > end - intersyllablespace
%\temp=\previousenddifference %
%\advance\temp by \intersyllablenotesspace %
%\ifdim#1 >\temp %
%\kern #1 %
%test3%
%\else%
%\kern\temp%
%test4%
%\fi%
%\fi%
%}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of bars
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% we define two types of macro for each four bar : when it is inside a syllable, and when it is not

\def\invirgula{%
\writebar{0}{1}%
\relax%
}

\def\virgula{%
\writebar{0}{0}%
\relax%
}

\def\indivisiominima{%
\writebar{1}{1}%
\relax%
}

\def\divisiominima{%
\writebar{1}{0}%
\relax%
}

\def\indivisiominor{%
\writebar{2}{1}%
\relax%
}

\def\divisiominor{%
\writebar{2}{0}%
\relax%
}

\def\indivisiomaior{%
\writebar{3}{1}%
\relax%
}

\def\divisiomaior{%
\writebar{3}{0}%
\relax%
}

\newdimen\temptwo

\def\indivisiofinalis{%
\ifcase\endofscore %
\writebar{4}{1}%
\or %
\writebar{5}{1}%
\fi %
\relax%
}

\def\divisiofinalis{%
\ifcase\endofscore %
\writebar{4}{0}%
\or %
\writebar{5}{0}%
\fi %
\relax%
}

%a macro to write a bar
%% 1: the type of the bar : 0 for virgula, 1 for minima 2 for minor, 3 for major, 4 for finalis and 5 for the last finalis
%% 2: is % for now we don't use it
%%% 0 if it is outside a syllable
%%% 1 if it is in a syllable
\def\writebar#1#2{%
\ifcase#1 % 0 : virgula
\penalty 7000 %
\ifnum#2=1\relax %
\hskip\spacebeforesmallbar %
\penalty 7000 %
\fi %
\calculateglyphraisevalue{g}{0}% bar glyphs are made to be at this height
\raise\glyphraisevalue\hbox{\gregorianfont \char 8}%
\penalty -5000 %
\ifnum#2=1\relax %
\hskip\spaceaftersmallbar %
\fi %
\or % 1 : minima
\penalty 7000%
\ifnum#2=1\relax %
\hskip\spacebeforesmallbar %
\penalty 7000%
\fi %
\calculateglyphraisevalue{g}{0}% bar glyphs are made to be at this height
\raise\glyphraisevalue\hbox{\gregorianfont \char 9}%
\penalty -5000%
\ifnum#2=1\relax %
\hskip\spaceaftersmallbar %
\fi %
\or % 2 : minor
\penalty 7000 %
\ifnum#2=1\relax %
\hskip\spacebeforeminor %
\penalty 7000 %
\fi %
\calculateglyphraisevalue{g}{0}% bar glyphs are made to be at this height
\raise\glyphraisevalue\hbox{\gregorianfont \char 10}%
\penalty -5000 %
\ifnum#2=1\relax %
\hskip\spaceafterminor %
\fi %
\or % 3 : maior
\penalty 7000 %
\ifnum#2=1\relax %
\hskip\spacebeforemaior %
\penalty 7000 %
\fi %
\calculateglyphraisevalue{g}{0}% bar glyphs are made to be at this height
\raise\glyphraisevalue\hbox{\gregorianfont \char 11}%
\penalty -5000 %
\ifnum#2=1\relax %
\hskip\spaceaftermaior %
\fi %
\or % 4 : finalis
\penalty 7000 %
\ifnum#2=1\relax %
\hskip\spacebeforefinalis %
\penalty 7000 %
\fi %
\divisiofinalissymbol%
\penalty -5000 %
\ifnum#2=1\relax %
\hskip\spaceafterfinalis %
\fi %
\or % 5 : finalis
\penalty 7000 %
\ifnum#2=1\relax %
\hskip\spacebeforefinalfinalis %
\penalty 7000 %
\fi %
\divisiofinalissymbol%
\penalty -5000 %
\ifnum#2=1\relax %
\hskip\spaceafterfinalis %
\fi %
\fi %
\relax%
}

\def\divisiofinalissymbol{%
\calculateglyphraisevalue{g}{0}% bar glyphs are made to be at this height
\raise\glyphraisevalue\hbox{\gregorianfont \char 11}%
\temptwo = 12000 sp%
\multiply\temptwo by \the\factor%
\kern \temptwo%
\penalty 10000%
\raise\glyphraisevalue\hbox{\gregorianfont \char 11}%
}

%a count to tell if we have to keep the localrightbox until the end
\newcount\keeprightbox

%macro to end a line with a divisio finalis
\def\finaldivisiofinalis{%
\hskip\spacebeforefinalfinalis %
\global\keeprightbox=1 %
\localrightbox{%
\divisiofinalissymbol %
}%
\relax%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for typesetting alterations
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% a count saying if the first glyph is an alteration
\newcount\firstisalteration

\def\flat#1{%
\ifnum\the\firstglyph=1\relax %
\global\firstisalteration=1\relax %
\fi %
\calculateglyphraisevalue{#1}{0}%
\setbox\Tempwidth=\hbox{\gregorianfont \char 6}%
\tempwidth=\wd\Tempwidth%
\raise \glyphraisevalue%
\copy\Tempwidth%
\ifnum\the\firstglyph=1\relax %
\temp=\wd\Tempwidth %
\advance\temp by \alterationspace %
\global\advance\notesaligncenter by \temp %
\kern\alterationspace %
\else %
\hskip\alterationspace %
\fi %
\relax%
}

\def\natural#1{%
\ifnum\the\firstglyph=1\relax %
\global\firstisalteration=1\relax %
\fi %
\calculateglyphraisevalue{#1}{0}%
\setbox\Tempwidth=\hbox{\gregorianfont \char 6}%
\tempwidth=\wd\Tempwidth%
\raise \glyphraisevalue%
\copy\Tempwidth%
\ifnum\the\firstglyph=1\relax %
\temp=\wd\Tempwidth %
\advance\temp by \alterationspace %
\global\advance\notesaligncenter by \temp %
\kern\alterationspace %
\else %
\hskip\alterationspace %
\fi %
\relax%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% other macros
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%macro called at the beginning of a score
\def\begingregorioscore{%
\noindent%
%\directlua0 {%
%local hlist = node.id('hlist')
%tempnode=node.new(node.id('glyph'), 0)
%tempnode.font=65 % TODO : don't know why 65...
%tempnode.char=tex.defaulthyphenchar
%dashnode=node.hpack(tempnode)
%dashnode.shift=393216 % TODO : a less static value
%function addhyphen(h, groupcode, glyphes)
%    local lastseennode=nil
%    local attributeid=1
%    local potentialdashvalue=3
%    local nopotentialdashvalue=2
%    local adddash=false
%    % we explore the lines
%    for a in node.traverse_id(hlist, h) do
%        for b in node.traverse_id(hlist, a.list) do
%            if adddash == false then
%                if node.has_attribute(b, attributeid, potentialdashvalue) then
%                    adddash=true
%                    lastseennode=b
%                    attr = b.attr.next
%                    %texio.write_nl('ATTR number = ' .. attr.number .. ' value = ' .. attr.value)
%                end
%            else
%                if node.has_attribute(b, attributeid, nopotentialdashvalue) then
%                    adddash=false
%                    attr = b.attr.next
%                    %texio.write_nl('ATTR number = ' .. attr.number .. ' value = ' .. attr.value)
%                end 
%            end
%        end
%        if adddash==true then
%            local temp= node.copy(dashnode)
%            %TODO: remove the last glue in b first, and insert a glue of ancient glue - withdof(dashnode) after the dash
%            node.insert_after(a.list, b, temp)
%            addash=false
%        end
%    end
%    return true
%end 
%callback.register('post_linebreak_filter', addhyphen)
%}%
\relax%
}

%macro called at the beginning of a score
\def\endgregorioscore{%
\localleftbox{}%
\ifnum\keeprightbox=0 %
\localrightbox{}%
\fi %
\hfil %
\par%
\ifnum\keeprightbox=1 %
\localrightbox{}%
\global\keeprightbox=0 %
\fi%
\relax%
}

%macro to call if you wan to go to the next line
\def\grenewline{%
%\hfil%
\penalty-10000 %
\relax%
}

%macro to call when there is just a little thing that will go to the last line, when it is not necessary
\def\gnolastline{%
\ifdim\enddifference > 0 pt %
\ifdim\nextbegindifference > 0 pt %
\hskip\interwordspacenotes %
\else % (next begin difference >0pt)
\hskip\interwordspacenotestext %
\fi %
\else%(enddifference < Opt)
\ifdim\nextbegindifference < 0 pt %
\hskip\interwordspacetext %
\else %(next begin difference < 0 pt)
\hskip\interwordspacetextnotes %
\fi %
\fi %
\global\endofscore=1 %
\localrightbox{}%
\localleftbox{}%
\penalty 1000 %
\relax%
}

% macro called at each end of word
\def\endofword{%
\ifdim\enddifference > 0 pt %
\ifdim\nextbegindifference > 0 pt %
\hskip\interwordspacenotes %
\else % (next begin difference >0pt)
\hskip\interwordspacenotestext %
\fi %
\else%(enddifference < Opt)
\ifdim\nextbegindifference < 0 pt %
\hskip\interwordspacetext %
\else %(next begin difference < 0 pt)
\hskip\interwordspacetextnotes %
\fi %
\fi %
\penalty -1000%
\global\enddifference=0pt %
\relax%
}

% macro called at the end of a word or syllable when the next thing is a bar
\def\endbeforebar{%
%
}

\newcount\lastoflinecount

% macro to tell gregorioTeX no to put a space after the current syllable (otherwise it may cause annoying black boxes in the pdf)
\def\lastofline{%
\global\lastoflinecount=1\relax%
\relax%
}

% macro called at each end of syllable which is not an end of word
\def\endofsyllable{%
\penalty -500%
\relax%
}

% macro to end elements, argument is the type of space, it can be : 
%% 0 : default space 
%% 1 : larger space
%% 2 : glyph space

\def\endofelement#1{%
\ifcase#1%
\hskip\interelementspace%
\or% case 1
\hskip\largerspace%
\or% case 2
\hskip\glyphspace%
\fi%
\penalty -100%
\relax%
}

% macro to end a glyph without ending the element, argument is the type of space, it can be : 
%% 0: default space 
%% 1: zero width space
%% 2: space between flat or natural and a note
%% 3: space between two puncta inclinata
%% 7: space between a punctum inclinatum and a punctum inclinatum deminutus
%% 8: space between two puncta inclinata deminuti
%% 4: space between bivirga or bistropha
%% 5: space between tristropha or trivirga
%% 6: space after a punctum mora XXX: not used yet, not so sure it is a good idea...
%% 7: space between a punctum inclinatum and a punctum inclinatum debilis
%% 8: space between two puncta inclinata debilis
%% 9: space before a punctum (or something else) and a punctum inclinatum
\def\endofglyph#1{%
\ifcase#1%
\hskip\interglyphspace %
\or% case 1
\hskip\zerowidthspace %
\or% case 2
\hskip\alterationspace %
\or% case 3
\hskip\punctuminclinatumshift %
\or% case 4
\hskip\bispace %
\or% case 5
\hskip\trispace %
\or% case 6
\hskip\spaceaftersigns %
\or% case 7
\hskip\punctuminclinatumanddebilisshift %
\or% case 8
\hskip\punctuminclinatumdebilisshift %
\or% case 9
\hskip\beforepunctainclinatashift %
\fi%
\penalty 10001%
\relax%
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of spaces
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% null space
\newskip\zerowidthspace
\zerowidthspace=0pt plus 0pt minus 0pt

% space between glyphs in the same element
\newskip\interglyphspace
\interglyphspace = 8200 sp plus 820 sp minus 820 sp
\multiply\interglyphspace by \factor

% space between an alteration (flat or natural) and the next glyph
\newskip\alterationspace
\alterationspace = 12000 sp plus 2300 sp minus 1200 sp
\multiply\alterationspace by \factor

% negative space, difference between the normal space between two notes and the space between a note and a flat
\newskip\beforealterationspace
\beforealterationspace = -36000 sp plus 1200 sp minus 1200 sp
\multiply\beforealterationspace by \factor

% space between elements
\newskip\interelementspace
\interelementspace = 8200 sp plus 1400 sp minus 820 sp
\multiply\interelementspace by \factor

% larger space between elements
\newskip\largerspace
\largerspace = 8200 sp plus 1400 sp minus 820 sp
\multiply\largerspace by \factor

% space between elements which has the size of a note
\newskip\glyphspace
\glyphspace = 16500 sp plus 2500 sp minus 1650 sp
\multiply\glyphspace by \factor

% minimum space between two notes of different syllables
\newskip\intersyllablespace
\intersyllablespace=28000 sp plus 3000 sp minus 0 sp
%\intersyllablespace=0 sp plus 0 sp minus 0 sp
\multiply\intersyllablespace by \factor

% space before custo
\newskip\spacebeforecusto
\spacebeforecusto = 16500 sp plus 16500 sp minus 8000 sp
\multiply\spacebeforecusto by \factor

% space before punctum mora and augmentum duplex
\newskip\spacebeforesigns
\spacebeforesigns=5000 sp plus 500 sp minus 500 sp
\multiply\spacebeforesigns by \factor

% space after punctum mora and augmentum duplex
\newskip\spaceaftersigns
\spaceaftersigns=9000 sp plus 900 sp minus 900 sp
\multiply\spaceaftersigns by \factor

% space after a clef at the beginning of a line
\newskip\spaceafterlineclef
\spaceafterlineclef = 16500 sp plus 4000 sp minus 1650 sp
\multiply\spaceafterlineclef by \factor

% space after at the end of a word when the last written symbol is a note and the first is a note
\newskip\interwordspacenotes
\interwordspacenotes = 32000 sp plus 6400 sp minus 3200 sp
\multiply\interwordspacenotes by \factor

% space after at the end of a word when the last written symbol is a note and the first is text
\newskip\interwordspacenotestext
\interwordspacenotestext = 35000 sp plus 5000 sp minus 2500 sp
\multiply\interwordspacenotestext by \factor

% space after at the end of a word when the last written symbol is text and the first is a note
\newskip\interwordspacetextnotes
\interwordspacetextnotes = 30000 sp plus 6000 sp minus 3000 sp
\multiply\interwordspacetextnotes by \factor

% space after at the end of a word when the last written symbol is text and the first is text
\newskip\interwordspacetext
\interwordspacetext = 25000 sp plus 7000 sp minus 2500 sp
\multiply\interwordspacetext by \factor

% space between notes of a bistropha and bivirga
\newskip\bispace
\bispace = 16500 sp plus 1650 sp minus 1650 sp
\multiply\bispace by \factor

% space between notes of a tristropha and trivirga
\newskip\trispace
\trispace = 16500 sp plus 1650 sp minus 1650 sp
\multiply\trispace by \factor

% space between two punctum inclinatum
\newskip\punctuminclinatumshift
\punctuminclinatumshift=-4850 sp plus 100 sp minus 100 sp
\multiply\punctuminclinatumshift by \factor

% space before puncta inclinata
\newskip\beforepunctainclinatashift
\beforepunctainclinatashift=5800 sp plus 800 sp minus 500 sp
\multiply\beforepunctainclinatashift by \factor

% space between a punctum inclinatum and a punctum inclinatum deminutus
\newskip\punctuminclinatumanddebilisshift
\punctuminclinatumanddebilisshift=-3000 sp plus 100 sp minus 100 sp
\multiply\punctuminclinatumanddebilisshift by \factor

% space between two punctum inclinatum deminutus
\newskip\punctuminclinatumdebilisshift
\punctuminclinatumdebilisshift=-1300 sp plus 100 sp minus 100 sp
\multiply\punctuminclinatumdebilisshift by \factor

% space for the bars
%first for virgula and divisio minima
\newskip\spacebeforesmallbar
\spacebeforesmallbar = 8500 sp plus 1650 sp minus 1650 sp
\multiply\spacebeforesmallbar by \factor

\newskip\spaceaftersmallbar
\spaceaftersmallbar = 8500 sp plus 1650 sp minus 1650 sp
\multiply\spaceaftersmallbar by \factor

%then divisio minor
\newskip\spacebeforeminor
\spacebeforeminor = 8500 sp plus 1650 sp minus 1650 sp
\multiply\spacebeforeminor by \factor

\newskip\spaceafterminor
\spaceafterminor = 8500 sp plus 1650 sp minus 1650 sp
\multiply\spaceafterminor by \factor

%divisio major
\newskip\spacebeforemaior
\spacebeforemaior = 8500 sp plus 1650 sp minus 1650 sp
\multiply\spacebeforemaior by \factor

\newskip\spaceaftermaior
\spaceaftermaior = 8500 sp plus 1650 sp minus 1650 sp
\multiply\spaceaftermaior by \factor

%divisio finalis
\newskip\spacebeforefinalis
\spacebeforefinalis = 8500 sp plus 1650 sp minus 1650 sp
\multiply\spacebeforefinalis by \factor

%a special space for finalis, for when it is the last glyph
\newskip\spacebeforefinalfinalis
\spacebeforefinalfinalis= 32000 sp plus 3000 sp minus 16000 sp
\multiply\spacebeforefinalfinalis by \factor

\newskip\spaceafterfinalis
\spaceafterfinalis = 8500 sp plus 1650 sp minus 6000 sp
\multiply\spaceafterfinalis by \factor

% space between the text and the text of the bar
\newskip\textbartextspace
\textbartextspace = 13000 sp plus 1300 sp minus 1300 sp
\multiply\textbartextspace by \factor

% minimal space between a note and a bar
\newskip\notebarspace
\notebarspace = 21000 sp plus 10000 sp minus 2100 sp
\multiply\notebarspace by \factor

\newdimen\maximumspacewithoutdash
\maximumspacewithoutdash = 4000 sp
\multiply\maximumspacewithoutdash by \factor

% space between the initial and the beginning of the score
\newskip\afterinitialshift
\afterinitialshift=0.6 em plus 0em minus 0em

% space before the initial and the beginning of the score
\newskip\beforeinitialshift
\afterinitialshift=0.6 em plus 0em minus 0em

\def\setspaceafterinitial#1{%
\afterinitialshift=#1 %
\relax %
}

\def\setspacebeforeinitial#1{%
\beforeinitialshift=#1 %
\relax %
}

% space for the clef changes
\newskip\clefchangespace

%%%%%%%%
%% fonts
%%%%%%%%

% the macros to typeset the A, R and V with bar
\def\Abar{%
{\gregoriansymbolfont \char 64}%
\relax%
}

\def\Rbar{%
{\gregoriansymbolfont \char 65}%
\relax%
}

\def\Vbar{%
{\gregoriansymbolfont \char 66}%
\relax%
}

% a V with bar more adapted to small text
\def\Vbarsmall{%
{\gregoriansymbolfont \char 72}%
\relax%
}

% the macro to typeset a dagger
\def\gredagger{%
{\gregoriansymbolfont \char 68}%
\relax%
}

% macro to typeset a (malt) cross
\def\grecross{%
{\gregoriansymbolfont \char 70}%
\relax%
}

%the macro to write a star
\def\grestar{%
\gresixstar %
\relax%
}

\def\greheightstar{%
{\gregoriansymbolfont \char 69}%
\relax %
}

\def\gresixstar{%
{\gregoriansymbolfont \char 71}%
\relax %
}

\def\greitalic#1{%
{\it #1}%
\relax %
}

\def\gresmallcaps#1{%
{\sc #1}%
\relax %
}

\def\greboldfont#1{%
{\bf #1}%
\relax %
}

\def\grett#1{%
{\tt #1}%
\relax %
}

\newcount\tempfactor %

\def\setgregorianfont#1{%
\tempfactor = \the\factor %
\multiply\tempfactor by 100000 %
\global\font\gregorianfont=#1 at \the\tempfactor sp%
\global\font\gregoriantextfont=#1 at 11pt%
\relax%
}

\tempfactor = \the\factor %
\multiply\tempfactor by 100000 %
% we open the font at \factor pt, we must know \factor because it will determine the line heigth, etc. 
\font\gregorianfont=greciliae at \the\tempfactor sp

\font\gregoriansymbolfont=gresym at 12pt

\font\textfont=pncr at 12pt
\font\fontofinitial=pncr at 40pt

\def\setfactor#1{%
\global\factor=#1 %
%\global\multiply\factor by 100000 %
\relax %
}
