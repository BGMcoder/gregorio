%GregorioTeX file.
%Copyright (C) 2007 Elie Roux <elie.roux@enst-bretagne.fr>
%
%This program is free software: you can redistribute it and/or modify
%it under the terms of the GNU General Public License as published by
%the Free Software Foundation, either version 3 of the License, or
%(at your option) any later version.
%
%This program is distributed in the hope that it will be useful,
%but WITHOUT ANY WARRANTY; without even the implied warranty of
%MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%GNU General Public License for more details.
%
%You should have received a copy of the GNU General Public License
%along with this program.  If not, see <http://www.gnu.org/licenses/>.

% this file contains definitions for lines, initial, fonts, etc.

%%%%%%%%%%%%%%
%% basic start
%%%%%%%%%%%%%%

% factor is the factor with which you open you font (the number after the at). It will decide almost everything (spaces, etc.), so it is particularly important.
% at the beginning it is set to 0, but if it is still 0 when begingregorianscore is called, it is set to the default value : 17 (the value that makes it look like a standard graduale)
\newcount\grefactor
\grefactor=0


%%%%%%%%%%%%%%%%%%
%% vertical spaces
%%%%%%%%%%%%%%%%%%

% \stafflineheight is the height of a staff line
\newdimen\stafflineheight
% \interstafflinespace is the space between two lines of staff
\newdimen\interstafflinespace
% \staffheight is the total height of the staff : that is to say the four written lines
\newdimen\staffheight 

% vertical spaces
%the space above the lines
\newskip\spaceabovelines

%the space between the lines and the bottom of the text
\newskip\spacelinestext

%the space beneath the text
\newskip\spacebeneathtext

%constantglyphraise is the space between the 0 of the gragorian fonts and the effective 0 of the TeX score
\newdimen\constantglyphraise %


% \stafflinewidth is the width of a line of staff, this can vary, for example at the first line
\newdimen\stafflinewidth

\def\setgreverticalspaces{
\global\stafflineheight=1500 sp%
\global\multiply\stafflineheight by \the\grefactor %
\global\interstafflinespace=30000 sp%
\global\multiply\interstafflinespace by \the\grefactor %
\global\staffheight=4\stafflineheight %
\global\advance\staffheight by 3\interstafflinespace %
\global\spaceabovelines = 50000 sp plus 40000 sp minus 10000 sp%
\global\multiply\spaceabovelines by \grefactor %
\global\spacelinestext = 63500 sp plus 0 sp minus 0 sp%
\global\multiply\spacelinestext by \grefactor %
\global\spacebeneathtext = 0 sp plus 0 sp minus 0 sp%
%\global\multiply\spacebeneathtext by \grefactor % uncomment it if you want
% something else than 0
\global\textlower=\spacebeneathtext %
\global\calculateconstantglyphraise %
\relax %
}

\newdimen\linewidth
\linewidth=\hsize 
\stafflinewidth=\linewidth 

% to calculate that, we take the bottom of the third line : it is at 200 in the fonts, and it must be at spacelinestext + spacebeneathtext + 2*interstafflinespace + 2*stafflineheight + translationheight
\def\calculateconstantglyphraise{%
\global\constantglyphraise = -22000 sp%
\global\multiply\constantglyphraise by \the\grefactor %
\global\advance\constantglyphraise by \additionalbottomspace %
\global\advance\constantglyphraise by \spacebeneathtext %
\global\advance\constantglyphraise by \spacelinestext %
\global\advance\constantglyphraise by \interstafflinespace %
\global\advance\constantglyphraise by \interstafflinespace %
\global\advance\constantglyphraise by \stafflineheight %
\global\advance\constantglyphraise by \stafflineheight %
\global\advance\constantglyphraise by \translationheight %
\relax %
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for additionnal vertical spaces
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% additional space for the translation, beneath the text
\newdimen\translationheight

% macro to tell gregorio to set space for the translation
\def\addtranslationspace{%
\global\translationheight=60000 sp%
\global\multiply\translationheight by \the\grefactor %
\global\textlower=\spacebeneathtext %
\global\advance\textlower by \translationheight %
\generatelines %
\calculateconstantglyphraise %
\relax %
}

\def\removetranslationspace{%
\global\translationheight=0 sp%
\global\textlower=\spacebeneathtext %
\generatelines %
\calculateconstantglyphraise %
\relax %
}

%macro to call if you want to go to the next line simply
\def\grenewline{%
\updateadditionalspaces{0}{0}%
\removetranslationspace %
\lastoflinecount=2\relax %
\updateleftbox %
\penalty-10001 %
\relax%
}

% macro called to go to the next line but when there are additional vertical spaces to add
%% 1: can be 0, 1 or 2 or 3. 1 is when there is a note above the 4th line, 2 when there is a note on the 5th line, and 3 when there is a note above the 5th line
%% 2: idem, but with the bottom line (-1th)
%% 3: 1 if there is a translation somewhere
\def\grenewlinewithspace#1#2#3{%
\updateadditionalspaces{#1}{#2}%
\ifnum#3 = 1\relax %
\addtranslationspace %
\else %
\removetranslationspace %
\fi %
\lastoflinecount=2\relax %
\updateleftbox %
\penalty-10001 %
\relax%
}


% basically same macros as above, but these one do a \hfill, the lines are not justified
%macro to call if you want to go to the next line simply
\def\grenewparline{%
\updateadditionalspaces{0}{0}%
\removetranslationspace %
\lastoflinecount=2\relax %
\updateleftbox %
\hfill %
\penalty-10001 %
\relax%
}

\def\grenewparlinewithspace#1#2#3{%
\updateadditionalspaces{#1}{#2}%
\ifnum#3 = 1\relax %
\addtranslationspace %
\else %
\removetranslationspace %
\fi %
\lastoflinecount=2\relax %
\updateleftbox %
\hfill %
\penalty-10001 %
\relax%
}

% two dimensions for the additionalspaces
\newdimen\additionalbottomspace
\newdimen\additionaltopspace

% same arguments as grenewlinewithspace
\def\updateadditionalspaces#1#2{%
\ifcase#1\relax %
\global\additionalbottomspace=0 sp%
\or % case 1
\global\additionalbottomspace=0 sp%
% here we don't add any space... it's just in case...
\or % case 2
\global\additionaltopspace=15000 sp%
\global\multiply\additionaltopspace by \the\grefactor %
\or % case 3
\global\additionaltopspace=30000 sp%
\global\multiply\additionaltopspace by \the\grefactor %
\fi %
\ifcase#2\relax %
% case 0
\global\additionalbottomspace=0 sp%
\or % case 1
\global\additionalbottomspace=0 sp%
\or % case 2
\global\additionalbottomspace=15000 sp%
\global\multiply\additionalbottomspace by \the\grefactor %
\or % case 3
\global\additionalbottomspace=30000 sp%
\global\multiply\additionalbottomspace by \the\grefactor %
\fi %
\generatelines %
\calculateconstantglyphraise %
\relax %
}

%% macros for additional bottom space for the first line

% #1 is 1, 2 or 3, with the same signification as in grenewlinewithspace
\def\firstlinebottomspace#1#2{%
%TODO
\ifcase#1\relax %
% case 0
\global\additionalbottomspace=0 sp%
\or % case 1
\global\additionalbottomspace=0 sp%
\or % case 2
\global\additionalbottomspace=15000 sp%
\global\multiply\additionalbottomspace by \the\grefactor %
\or % case 3
\global\additionalbottomspace=30000 sp%
\global\multiply\additionalbottomspace by \the\grefactor %
\fi %
\ifnum#2=1\relax %
\addtranslationspace %
\else %
\removetranslationspace %
\fi %
\generatelines %
\calculateconstantglyphraise %
\relax %
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of text
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

% \textlower is the height of the separation between the bottom line (which is invisible : for the notes which are very low) and the bottom of the text
\newdimen\textlower
\textlower=\spacebeneathtext
%\advance\textlower by \translationheight

%% macro that sets \temp to the width of its argument

\newbox\Tempwidth
\newdimen\tempwidth

\def\widthof#1{%
\setbox\Tempwidth=\hbox{#1}%
\tempwidth=\wd\Tempwidth%
\relax%
}

%% macro that typesets the text of the syllable, and sets \textaligncenter to the middle of the middle letters, it is needed because we align the note (often the middle of the note) with the middle of the middle letters
%% warning : textaligncenter is the width from the beginning of the letters to the middle of the middle letters

\newdimen\textaligncenter

\def\findtextaligncenter#1#2{%
\widthof{\gretextformat{#1#2}}%
\global\textaligncenter=\the\tempwidth %
\widthof{\gretextformat{#2}}%
\divide\tempwidth by 2 %
\global\advance\textaligncenter by -\the\tempwidth%
\relax%
}

% definition of the dash that we will use after the text if necessary
\def\gregoriotextdash{-}
\newdimen\gregoriotextdashwidth
\widthof{\gregoriotextdash}
\gregoriotextdashwidth=\tempwidth

\def\writetranslation#1{%
\raise\spacebeneathtext\hbox to 0pt{\vbox to 0pt{\vss\hbox to 0pt{\gretranslationformat{#1}\hss}}}%
\relax %
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of the initial
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%this dimention is the additional space that we have to add to the localleftbox sometimes. For now it is used only for the initials on two lines
\newdimen\additionalleftspace

%% box containing the initial, and dimen containing its width (and the width of the space after)
\newbox\Initial
\newdimen\initialwidth
\initialwidth= 0 pt


% biginitial means that the inital takes two lines
\newcount\biginitial

% macro to call before the call of \initial
\def\setbiginitial{%
\global\biginitial=1\relax %
\relax %
}

% macro to call before the first syllable, but after setinitialclef
\def\adjustsecondline{%
\additionalleftspace=\initialwidth %
\updateleftbox %
\relax %
}

% macro to call during the second line
\def\adjustthirdline {%
\additionalleftspace= 0 pt%
\updateleftbox %
\relax %
}

\def\updateleftbox{%
\updatelinewidth %
\updatelinesclef %
}

\def\updatelinewidth{%
\ifdim\additionalleftspace=0pt%
\else %
\temp=\stafflinewidth %
\global\advance\stafflinewidth by -\additionalleftspace %
\generatelines %
\global\stafflinewidth=\temp %
\fi %
}

\def\greinitial#1{%
% we print the initial always at the same place, and the we print the Aboveinitialbox centered
% first we print the initial
\temp=-\textlower %
% if it is a big initial we print it on the second line 
\ifnum\biginitial=0\relax %
\setbox\Initial=\hbox{\greinitialformat{#1}}%
\global\initialwidth=\the\wd\Initial %
\setbox\Initial=\hbox{\raise -\temp\hbox{\greinitialformat{#1}}}%
\else %
\advance\temp by \additionalbottomspace %
\advance\temp by \spacebeneathtext %
\advance\temp by \spacelinestext %
\advance\temp by 4\interstafflinespace %
\advance\temp by 4\stafflineheight %
\advance\temp by \translationheight %
\setbox\Initial=\hbox{\grebiginitialformat{#1}}%
\global\initialwidth=\the\wd\Initial %
\setbox\Initial=\hbox{\vbox to 0pt{\hbox{\raise -\temp\hbox{\grebiginitialformat{#1}}}\vss}}%
\fi %
\hskip\beforeinitialshift %
\copy\Initial%
\hskip\afterinitialshift %
\global\advance\initialwidth by \afterinitialshift%
\global\advance\initialwidth by \beforeinitialshift %
% then we center the box above the initial, if there is one
\ifdim\wd\Aboveinitialbox=0 pt\relax %
\else %
\temp=\initialwidth %
\advance\temp by -\wd\Aboveinitialbox %
\divide\temp by 2 %
\hskip -\initialwidth %
\kern\temp %
\raise\aboveinitialraise\copy\Aboveinitialbox %
\kern\temp %
\setbox\Aboveinitialbox=\hbox{}%
\fi %
\relax %
}

\def\grenoinitial{%
\setbox\Initial=\hbox{}%
\global\initialwidth=0pt %
\global\lastoflinecount=2\relax %
\relax %
}

\newbox\Aboveinitialbox %
\newdimen\aboveinitialraise %

\def\setfirstlineaboveinitial#1#2{%
\ifnum\grefactor=0\relax %
\setgrefactor{17}%
\fi %
\global\aboveinitialraise=\staffheight %
\global\advance\aboveinitialraise by \spacebeneathtext %
\global\advance\constantglyphraise by \translationheight %
\global\advance\aboveinitialraise by \spacelinestext %
% we align the top of the box with the top of the line
\setbox\Aboveinitialbox=\hbox{#2}%
\global\advance\aboveinitialraise by -\ht\Aboveinitialbox %
\global\setbox\Aboveinitialbox=\hbox{#1}%
\relax %
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting the things above the initial
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\def\writemode#1{%
\setfirstlineaboveinitial{\sc{\bf{#1}}}{\sc{\bf{#1}}}%
\relax %
}

\def\gregorianmode#1{%
\ifcase#1%
\or%
\writemode{I}%
\or%
\writemode{II}%
\or%
\writemode{III}%
\or%
\writemode{IV}%
\or%
\writemode{V}%
\or%
\writemode{VI}%
\or%
\writemode{VII}%
\or%
\writemode{VIII}%
\fi%
\relax%
}

\def\scorereference#1{%
\relax%
}

\def\beginscore{%
\drawlines%
\relax%
}

\def\commentary#1{%
\vbox{\hfill\hbox{#1}}%
\relax %
}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% macros for the typesetting of the lines
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%% macro that draws the stafflines on the first line, it is different from others due to the initial that can take some place, without lines
\def\drawfirstlines{%
\advance\stafflinewidth by -\initialwidth%
%\initialwidth=0pt%
\hbox to0pt{%
\vbox{%
\stafflinesformat %
\vskip\spaceabovelines %
\vskip\additionaltopspace %
\hrule height \stafflineheight width \stafflinewidth %
\kern\the\interstafflinespace %
\hrule height \stafflineheight width \stafflinewidth %
\kern\the\interstafflinespace %
\hrule height \stafflineheight width \stafflinewidth %
\kern\the\interstafflinespace %
\hrule height \stafflineheight width \stafflinewidth %
\vskip\spacelinestext %
\vskip\spacebeneathtext %
\vskip\translationheight %
\vskip\additionalbottomspace %
}%
\hss%
}%
\stafflinewidth=\linewidth%
\relax%
}

%% box containing the stafflines for other lines than the first
\newbox\Lines

% macro that must be called at each change of linewidth and grefactor
\def\generatelines{%
\setbox\Lines=\hbox to0pt{%
\vbox{%
\stafflinesformat %
\vskip\spaceabovelines %
\vskip\additionaltopspace %
\hrule height \stafflineheight width \stafflinewidth %
\kern\the\interstafflinespace %
\hrule height \stafflineheight width \stafflinewidth %
\kern\the\interstafflinespace %
\hrule height \stafflineheight width \stafflinewidth %
\kern\the\interstafflinespace %
\hrule height \stafflineheight width \stafflinewidth %
\vskip\spacelinestext %
\vskip\additionalbottomspace %
\vskip\spacebeneathtext %
\vskip\translationheight %
}%
\hss%
}%
\relax %
}

% macro called when the initial is big, and so when the second line is at the same level as the first
\def\smallsecondline{%
\temp=\stafflinewidth %
\global\advance\stafflinewidth by -\initialwidth %
\generatelines %
\global\stafflinewidth=\temp %
\relax %
}

% macro called when we are after the second line of a big initial, to have normal lines back
\def\normallines{%
\global\stafflinewidth=\linewidth %
\generatelines %
\relax %
}

%% macro that draws the lines : starts by the first and then draws the lines of every line.
%% has to be called before drawing the key, after drawing the initial
\def\drawlines{%
\drawfirstlines %
%%localeleftbox is a primitive of Omega, it draws the same box at the beginning of new lines (here after the first)
\localleftbox{%
\copy\Lines %
}%
\relax%
}

\input gregoriotex-signs.tex

\input gregoriotex-syllable.tex

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%% other macros
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


%macro called at the beginning of a score
\def\begingregorioscore{%
\global\stafflinewidth=\linewidth %
\generatelines %
\ifnum\grefactor=0\relax %
\setgrefactor{17}%
\setgreverticalspaces %
\fi %
\noindent%
%\directlua0 {%
%local hlist = node.id('hlist')
%tempnode=node.new(node.id('glyph'), 0)
%tempnode.font=65 % TODO : don't know why 65...
%tempnode.char=tex.defaulthyphenchar
%dashnode=node.hpack(tempnode)
%dashnode.shift=393216 % TODO : a less static value
%function addhyphen(h, groupcode, glyphes)
%    local lastseennode=nil
%    local attributeid=1
%    local potentialdashvalue=3
%    local nopotentialdashvalue=2
%    local adddash=false
%    % we explore the lines
%    for a in node.traverse_id(hlist, h) do
%        for b in node.traverse_id(hlist, a.list) do
%            if adddash == false then
%                if node.has_attribute(b, attributeid, potentialdashvalue) then
%                    adddash=true
%                    lastseennode=b
%                    attr = b.attr.next
%                    %texio.write_nl('ATTR number = ' .. attr.number .. ' value = ' .. attr.value)
%                end
%            else
%                if node.has_attribute(b, attributeid, nopotentialdashvalue) then
%                    adddash=false
%                    attr = b.attr.next
%                    %texio.write_nl('ATTR number = ' .. attr.number .. ' value = ' .. attr.value)
%                end 
%            end
%        end
%        if adddash==true then
%            local temp= node.copy(dashnode)
%            %TODO: remove the last glue in b first, and insert a glue of ancient glue - withdof(dashnode) after the dash
%            node.insert_after(a.list, b, temp)
%            addash=false
%        end
%    end
%    return true
%end 
%callback.register('post_linebreak_filter', addhyphen)
%}%
\relax%
}

%macro called at the beginning of a score
\def\endgregorioscore{%
\localleftbox{}%
\ifnum\keeprightbox=0 %
\localrightbox{}%
\fi %
\hfil %
\par%
\ifnum\keeprightbox=1 %
\localrightbox{}%
\global\keeprightbox=0 %
\fi%
\updateadditionalspaces{0}{0}%
\relax%
}

%macro to call when there is just a little thing that will go to the last line, when it is not necessary
\def\gnolastline{%
\ifdim\enddifference > 0 pt %
\ifdim\nextbegindifference > 0 pt %
\hskip\interwordspacenotes %
\else % (next begin difference >0pt)
\hskip\interwordspacenotestext %
\fi %
\else%(enddifference < Opt)
\ifdim\nextbegindifference < 0 pt %
\hskip\interwordspacetext %
\else %(next begin difference < 0 pt)
\hskip\interwordspacetextnotes %
\fi %
\fi %
\global\endofscore=1 %
\localrightbox{}%
\localleftbox{}%
\penalty 1000 %
\relax%
}

% macro called at each end of word
\def\endofword{%
\ifdim\enddifference > 0 pt %
\ifdim\nextbegindifference > 0 pt %
\hskip\interwordspacenotes %
\else % (next begin difference >0pt)
\hskip\interwordspacenotestext %
\fi %
\else%(enddifference < Opt)
\ifdim\nextbegindifference < 0 pt %
\hskip\interwordspacetext %
\else %(next begin difference < 0 pt)
\hskip\interwordspacetextnotes %
\fi %
\fi %
\penalty -1000%
\global\enddifference=0pt %
\relax%
}

% macro called at the end of a word or syllable when the next thing is a bar
\def\endbeforebar{%
%
}

\newcount\lastoflinecount

% macro to tell gregorioTeX no to put a space after the current syllable (otherwise it may cause annoying black boxes in the pdf if written in plainTeX)
% 0 if nothing
% 1 if the syllable is the last of the line
% 2 after it has finished the syllable, so when it is two it means that the syllable is the first of a line
\def\lastofline{%
\global\lastoflinecount=1\relax%
\relax%
}

% macro called at each end of syllable which is not an end of word
\def\endofsyllable{%
\penalty -500%
\relax%
}

% macro to end elements, argument is the type of space, it can be : 
%% 0 : default space 
%% 1 : larger space
%% 2 : glyph space

\def\endofelement#1{%
\ifcase#1%
\hskip\interelementspace%
\or% case 1
\hskip\largerspace%
\or% case 2
\hskip\glyphspace%
\fi%
\penalty -100%
\relax%
}

% macro to end a glyph without ending the element, argument is the type of space, it can be : 
%% 0: default space 
%% 1: zero width space
%% 2: space between flat or natural and a note
%% 3: space between two puncta inclinata
%% 7: space between a punctum inclinatum and a punctum inclinatum deminutus
%% 8: space between two puncta inclinata deminuti
%% 4: space between bivirga or bistropha
%% 5: space between tristropha or trivirga
%% 6: space after a punctum mora XXX: not used yet, not so sure it is a good idea...
%% 7: space between a punctum inclinatum and a punctum inclinatum debilis
%% 8: space between two puncta inclinata debilis
%% 9: space before a punctum (or something else) and a punctum inclinatum
\def\endofglyph#1{%
\ifcase#1%
\hskip\interglyphspace %
\or% case 1
\hskip\zerowidthspace %
\or% case 2
\hskip\alterationspace %
\or% case 3
\hskip\punctuminclinatumshift %
\or% case 4
\hskip\bispace %
\or% case 5
\hskip\trispace %
\or% case 6
\hskip\spaceaftersigns %
\or% case 7
\hskip\punctuminclinatumanddebilisshift %
\or% case 8
\hskip\punctuminclinatumdebilisshift %
\or% case 9
\hskip\beforepunctainclinatashift %
\fi%
\penalty 10001%
\relax%
}

\input gregoriotex-spaces.tex

\input gregoriotex-symbols.tex

%%%%%%%%
%% fonts
%%%%%%%%

\def\greitalic#1{%
{\it #1}%
\relax %
}

\def\gresmallcaps#1{%
{\sc #1}%
\relax %
}

\def\greboldfont#1{%
{\bf #1}%
\relax %
}

\def\grett#1{%
{\tt #1}%
\relax %
}

\def\setgregorianfont#1{%
\tempfactor = \the\grefactor %
\multiply\tempfactor by 100000 %
\global\font\gregorianfont=#1 at \the\tempfactor sp%
\relax%
}

% we open the font at 10 pt, this is a dumb value that will be overwritten by a call to setgrefactor
\font\gregorianfont=greciliae at 10pt

\def\gretextformat#1{%
#1\relax %
}

\def\gretranslationformat#1{%
#1\relax %
}

\def\stafflinesformat{%
\relax %
}

\def\greinitialformat#1{%
\font\grefontofinitial=pncr at 40pt%
{\grefontofinitial #1}%
\relax %
}

\def\grebiginitialformat#1{%
\font\grefontofbiginitial=pncr at 80pt%
{\grefontofbiginitial #1}%
\relax %
}

\def\setgrefactor#1{%
\global\grefactor=#1\relax %
\setgreverticalspaces %
\setgrespaces %
\generatelines %
\setgregorianfont{greciliae}%
\relax %
}
